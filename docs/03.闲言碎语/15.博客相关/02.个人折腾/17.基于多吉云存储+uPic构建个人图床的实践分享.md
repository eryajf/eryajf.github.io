---
title: åŸºäºå¤šå‰äº‘å­˜å‚¨+uPicæ„å»ºä¸ªäººå›¾åºŠçš„å®è·µåˆ†äº«
date: 2023-07-08 18:17:35
permalink: /pages/f3f2c7/
categories:
  - é—²è¨€ç¢è¯­
  - åšå®¢ç›¸å…³
  - ä¸ªäººæŠ˜è…¾
tags:
  -
---


## å‰è¨€

å¤§çº¦ä» 2021 å¹´å¼€å§‹ï¼Œæˆ‘çš„åšå®¢ä¸Šçš„å›¾ç‰‡ï¼Œéƒ½æ˜¯åŸºäºå¼€æºçš„å›¾åºŠç¨‹åºæ¥æ„ç­‘çš„ï¼Œè¿™ä¸ªå¼€æºçš„å›¾åºŠç¨‹åºæ˜¯ï¼š[imgurl](https://github.com/helloxz/imgurl)ï¼Œæˆ‘å¹³æ—¶çš„ä½¿ç”¨æµç¨‹å¤§æ¦‚æ˜¯è¿™æ ·ï¼šå…ˆåœ¨æœ¬åœ° Obsidian å°†æ–‡ç« å†™å°±ï¼Œç„¶åå†å¾€åšå®¢çš„[ä»“åº“](https://github.com/eryajf/eryajf.github.io)è½¬ç§»å¹¶äºŒæ¬¡å‘å¸ƒï¼Œå¦‚æœæ–‡ç« å¸¦æœ‰å›¾ç‰‡ï¼Œåˆ™ä¼šé€šè¿‡å·¥å…·å¯¹å›¾ç‰‡æ‰“æ°´å°ï¼Œç„¶ååœ¨æµè§ˆå™¨è®¿é—®å›¾åºŠï¼Œå°†å›¾ç‰‡ä¸Šä¼ åˆ°æœåŠ¡å™¨ï¼Œå†å°†æ–‡ç« ä¸­çš„å›¾ç‰‡ URL æ¢æ‰ã€‚

ä»¥ä¸Šå°±æ˜¯æˆ‘ä¹‹å‰çš„ä¸ªäººå›¾åºŠä½¿ç”¨ç»éªŒï¼Œä¸¤å¹´æ¥ä½¿ç”¨è¿˜ç®—æ˜¯æ¯”è¾ƒç¨³å®šå¯é çš„ã€‚

## å¥‘æœº

åªæ˜¯æœ€è¿‘å‘ç°ä¸€äº›é—®é¢˜ï¼Œå°±æ˜¯å¶å°”ç¨‹åºçš„ç™»é™†çŠ¶æ€å‡ºç°é—®é¢˜ï¼Œå¯¼è‡´è‡ªå·±è¢«å…³åœ¨é—¨å¤–ï¼Œè€Œæ— æ³•æ­£å¸¸ä¸Šä¼ å›¾ç‰‡ï¼Œå¦å¤–å°±æ˜¯ä¸€ç›´ä»¥æ¥é€šè¿‡æµè§ˆå™¨ä¸Šä¼ å›¾ç‰‡çš„æ–¹å¼ä¹Ÿè®©æˆ‘æ„Ÿåˆ°ä¸æ–¹ä¾¿ï¼Œä¸ªäººå†…å¿ƒä¹Ÿæ—©æ—©å°±ç§ä¸‹æƒ³è¦æ¢æ‰å›¾åºŠç¨‹åºçš„ç§å­ã€‚

æˆ‘æ›¾ç»å†™è¿‡ä¸€ç¯‡æœ‰å…³äºå›¾åºŠçš„æ–‡ç« ï¼š[ä¸å›¾åºŠç›¸å…³çš„å„ç§ä½“éªŒå®è·µ](https://wiki.eryajf.net/pages/2799.html#_1-picgo%E3%80%82)ï¼Œé‚£æ—¶å€™å¯¹äº‘å­˜å‚¨ä»¥åŠ CDN è¿™äº›éƒ½è¿˜ä¸å¤Ÿäº†è§£ï¼Œæ‰€ä»¥å§‹ç»ˆæ²¡æœ‰æŠŠäº‘å­˜å‚¨åˆ©ç”¨èµ·æ¥ã€‚

å¦å¤–ä¸€ä¸ªå¥‘æœºåœ¨äºï¼šæˆ‘äºä»Šå¹´ä¸‰æœˆä»½å°†åšå®¢ CDN åˆ‡æ¢åˆ°å¤šå‰äº‘ï¼Œå¹¶å‘å¸ƒäº†ä¸€ç¯‡å›½å†… CDN çš„è¯„æµ‹æ–‡ç« ï¼š[åšå®¢æ¥å…¥CDNçš„æŠ˜è…¾-å¯¹é˜¿é‡Œäº‘ä¸ƒç‰›äº‘è“æ˜“äº‘å¤šå‰äº‘å‡ å®¶CDNä½¿ç”¨è¯„æµ‹](https://wiki.eryajf.net/pages/1a0733/#%E5%89%8D%E8%A8%80)ï¼Œåœ¨æ–‡ç« é‡Œæ”¾äº†ä¸ªäººçš„é‚€è¯·é“¾æ¥ï¼Œå¹¶æ²¡æœ‰æƒ³è¿‡ä»¥æ­¤è·å¾—ä»€ä¹ˆã€‚ç„¶è€Œå°±åœ¨å‰å‡ å¤©ï¼Œå¿½ç„¶æ”¶åˆ°çŸ­ä¿¡ï¼Œå‘ç°ä¸Šä¸ªæœˆæœ‰äººé€šè¿‡æˆ‘çš„é“¾æ¥æ³¨å†Œäº†å¤šå‰äº‘ï¼Œå¹¶ä¸”è´­ä¹°äº†äº‘å­˜å‚¨çš„èµ„æºåŒ…ï¼Œä½¿å¾—æˆ‘ä¹Ÿè·å¾—äº†ä¸¤ç™¾å¤šçš„æ”¶ç›Š (æ„Ÿè°¢è¿™ä½ä¸çŸ¥åçš„æœ‹å‹)ï¼Œè¿™ä»¤æˆ‘æ„Ÿåˆ°éå¸¸æƒŠå–œï¼Œä¹Ÿè¿›ä¸€æ­¥æ¿€å‘æˆ‘å°è¯•æŠŠå›¾åºŠæ¥å…¥åˆ°å¤šå‰äº‘çš„äº‘å­˜å‚¨ã€‚

å› æ­¤ï¼Œåœ¨ä»‹ç»æˆ‘çš„è¿ç§»ä»¥åŠä¼˜é›…å®è·µä¹‹å‰ï¼Œå†ä¸€æ¬¡åˆ†äº«ä¸€ä¸‹æˆ‘çš„é‚€è¯·é“¾æ¥ï¼š


::: cardList 1
```yaml
- name: æ³¨å†Œå¤šå‰äº‘
  desc: ğŸ«¡ é€šè¿‡æˆ‘çš„é‚€è¯·é“¾æ¥æ³¨å†Œå¤šå‰äº‘ã€‚
  link: https://www.dogecloud.com/?iuid=5485
  bgColor: '#6393e2'
  textColor: '#242A38'
:::


å¦‚æœä½ çš„ç¡®æœ‰äº‘å­˜å‚¨ä¸CDNæ–¹é¢çš„ä½¿ç”¨éœ€è¦ï¼Œå¯é€šè¿‡æˆ‘çš„é‚€è¯·é“¾æ¥æ³¨å†Œå¤šå‰äº‘ï¼Œé‚£ä¹ˆä½ ç¬¬ä¸€å¹´çš„æ¶ˆè´¹æˆ‘å°†èƒ½æ‹¿åˆ°ä¸€äº›å¥–åŠ±ã€‚

å¤šå‰äº‘å¹¶æ²¡æœ‰ç»™æˆ‘ä»»ä½•å¹¿å‘Šè´¹ç”¨ï¼Œä½†æˆ‘ååˆ†æ„¿æ„æ¨èå¤šå‰äº‘ç»™å¤§å®¶ï¼Œå› ä¸ºè¿™ä¹Ÿæ˜¯æŠ˜è…¾äº†äº”å…­å¹´åšå®¢çš„æˆ‘ç»è¿‡å„ç§ä½“éªŒè¯„æµ‹ä¹‹åï¼Œè®¤ä¸ºå¯¹äºä¸ªäººåšå®¢ä½¿ç”¨è€…æœ€å‹å¥½ï¼Œæ€§ä»·æ¯”æœ€å¥½ï¼Œç¨³å®šæ€§ä¹Ÿä¸é”™çš„ä¸€å®¶æœåŠ¡å•†ã€‚

## è¿ç§»

å…ˆè¯´ä¸€ä¸‹åŸºäºå¤šå‰äº‘äº‘å­˜å‚¨å»ºç«‹å›¾åºŠçš„æ–¹å¼ä»¥åŠè®¿é—®æµç¨‹ï¼Œåœ¨äº‘å­˜å‚¨é‡Œè¾¹ï¼Œåˆ›å»ºä¸€ä¸ªç‹¬ç«‹çš„å­˜å‚¨ç©ºé—´ï¼Œç„¶åç»™è¿™ä¸ªå­˜å‚¨ç©ºé—´ç»‘å®šä¸€ä¸ªåŸŸåï¼Œå°±å¯ä»¥ç›´æ¥é€šè¿‡è¿™ä¸ªåŸŸåæ¥è®¿é—®å­˜å‚¨ç©ºé—´ä¸­çš„æ–‡ä»¶äº†ã€‚

å› ä¸ºæˆ‘ä¹‹å‰ä¸ªäººå›¾åºŠçš„å›¾ç‰‡éƒ½æ˜¯åœ¨æœåŠ¡å™¨æœ¬åœ°ï¼Œå› æ­¤åªéœ€è¦æŠŠå›¾ç‰‡å…¨é‡è½¬ç§»åˆ°å¤šå‰äº‘å­˜å‚¨é‡Œè¾¹ã€‚ç„¶åè·¯å¾„ä¸åŸæ¥ä¿æŒä¸€è‡´ï¼Œç„¶åå°†åŸæ¥å›¾åºŠå¯¹åº”çš„åŸŸåè§£ææ”¹åˆ°å¤šå‰äº‘çš„CDNåœ°å€å³å¯ã€‚

è¿™æ ·åªä¼šäº§ç”Ÿä¸€ä¸ªå­˜å‚¨çš„è´¹ç”¨ï¼Œä»¥åŠCDNçš„æµé‡è´¹ç”¨ï¼Œå› æ­¤ç›®å‰æˆ‘ä¸ªäººåšå®¢å›¾ç‰‡å­˜å‚¨é‡å¹¶ä¸å¤§ï¼Œå› æ­¤å­˜å‚¨çš„è´¹ç”¨æ¯ä¸ªæœˆå‡ ä¹å¯ä»¥å¿½ç•¥ä¸è®¡ï¼Œè€Œæµé‡è´¹ç”¨åˆ™åŸºæœ¬ä¸Šç­‰åŒäºåŸæ¥å›¾åºŠåŸŸåæ¥å…¥CDNçš„æµé‡è´¹ç”¨ï¼Œå› æ­¤æ•´ä½“ç®—æ¥ï¼Œè¿™è¿˜æ˜¯ä¸€ä¸ªæ€§ä»·æ¯”æ¯”è¾ƒé«˜çš„ä¸€æ¬¡è¿ç§»ã€‚

## ç»“åˆuPic

å› ä¸ºä½¿ç”¨äº‘å­˜å‚¨äº†ï¼Œå†åƒåŸæ¥æ¯æ¬¡ä¸Šä¼ å›¾ç‰‡è¿˜è¦æ‰“å¼€æµè§ˆå™¨å»ä¸Šä¼ å°±æ¯”è¾ƒlowäº†ï¼Œå› æ­¤æˆ‘å°±æ‰“ç®—æŠ˜è…¾ä¸€ä¸‹ï¼Œé€šè¿‡åŸæ¥ä¸€ç›´åœ¨ç”¨çš„ [uPic](https://github.com/gee1k/uPic) å›¾åºŠä¸Šä¼ è½¯ä»¶æ¥è¿›è¡Œä¸Šä¼ çš„åŠ¨ä½œçš„è§¦å‘ã€‚

äºæ˜¯å†™äº†ä¸€ä¸ªè„šæœ¬ï¼Œèµ·äº†ä¸€ä¸ªæ¥å—å›¾ç‰‡ä¸Šä¼ è¯·æ±‚ï¼Œå¹¶æŠŠå›¾ç‰‡ä¸Šä¼ åˆ°äº‘å­˜å‚¨çš„æœåŠ¡ï¼Œé€šè¿‡dockeræŠŠæœåŠ¡å®ˆæŠ¤åœ¨æœ¬åœ°ï¼Œç„¶åå€ŸåŠ©uPicçš„è‡ªå®šä¹‰ä¸Šä¼ èƒ½åŠ›ï¼Œå°†æ•´ä¸ªé“¾è·¯æ‰“é€šã€‚

### æœåŠ¡è„šæœ¬

è¿™é‡ŒæŠŠæœåŠ¡è„šæœ¬ç®€å•æ”¾åœ¨è¿™é‡Œï¼Œæœ‰éœ€è¦çš„åŒå­¦å¯è‡ªè¡Œæ‰“åŒ…éƒ¨ç½²ï¼Œå½“ç„¶ï¼Œå¦‚æœéœ€è¦çš„åŒå­¦æ¯”è¾ƒå¤šï¼Œè€Œä¸”ä¸æ–¹ä¾¿æ‰“åŒ…ï¼Œä¹Ÿå¯ä»¥åœ¨è¯„è®ºåŒºç•™è¨€ï¼Œå¦‚æœè¦çš„äººå¤šï¼Œæˆ‘å¯ä»¥èŠ±ç‚¹æ—¶é—´æŠ˜è…¾ä¸€ä¸‹ï¼ŒæŠŠé¡¹ç›®å¼€æºï¼Œç›´æ¥åšæˆä¸€é”®éƒ¨ç½²çš„æˆå“ã€‚

```go
package main

import (
	"crypto/hmac"
	"crypto/sha1"
	"encoding/hex"
	"encoding/json"
	"fmt"
	"io/ioutil"
	"log"
	"net/http"
	"net/url"
	"path/filepath"
	"strings"
	"time"

	"github.com/aws/aws-sdk-go/aws"
	"github.com/aws/aws-sdk-go/aws/credentials"
	"github.com/aws/aws-sdk-go/aws/session"
	"github.com/aws/aws-sdk-go/service/s3"
	"github.com/gin-gonic/gin"
)

var (
	// è¿™é‡Œæ›¿æ¢ä¸ºä½ çš„å¤šå‰äº‘æ°¸ä¹… AccessKey å’Œ SecretKeyï¼Œå¯åœ¨ç”¨æˆ·ä¸­å¿ƒ - å¯†é’¥ç®¡ç†ä¸­æŸ¥çœ‹
	// è¯·å‹¿åœ¨å®¢æˆ·ç«¯æš´éœ² AccessKey å’Œ SecretKeyï¼Œé‚£æ ·æ¶æ„ç”¨æˆ·å°†è·å¾—è´¦å·å®Œå…¨æ§åˆ¶æƒ
	AccessKey = "xxxxxx"
	SecretKey = "xxxxxxxxxxxxxxxxxxxx"
)

func main() {
	// åˆ›å»ºginå®ä¾‹
	r := gin.Default()

	// è®¾ç½®è·¯ç”±å’Œå¤„ç†å‡½æ•°
	r.POST("/upload", func(c *gin.Context) {
		file, err := c.FormFile("source")
		if err != nil {
			c.JSON(400, gin.H{
				"error": err.Error(),
			})
			return
		}
		src, err := file.Open()
		if err != nil {
			c.JSON(500, gin.H{
				"error": err.Error(),
			})
		}
		defer src.Close()
		fpath := getFilePath(file.Filename)
		_, err = GetS3Client().PutObject(&s3.PutObjectInput{
			Bucket: aws.String("s-sh-5485-wiki-images-1258813047"),
			Key:    aws.String(fpath),
			Body:   src,
		})
		if err != nil {
			fmt.Printf("æ–‡ä»¶ä¸Šä¼ å‡ºé”™ï¼Œè¯·æ£€æŸ¥: %v\n", err)
			c.JSON(500, gin.H{
				"error": err.Error(),
			})
		}

		c.JSON(200, gin.H{
			"code":    200,
			"url":     fpath,
			"message": "File uploaded successfully",
		})
	})

	// å¯åŠ¨æœåŠ¡å™¨
	r.Run(":666")
}

func getFilePath(name string) string {
	formattedTime := time.Unix(time.Now().Unix(), 0).Format("2006/01")
	return fmt.Sprintf("imgs/%s/%d%s", formattedTime, time.Now().UnixMilli(), filepath.Ext(name))
}

func DogeCloudAPI(apiPath string, data map[string]interface{}, jsonMode bool) (ret map[string]interface{}) {
	body := ""
	mime := ""
	if jsonMode {
		_body, err := json.Marshal(data)
		if err != nil {
			log.Fatalln(err)
		}
		body = string(_body)
		mime = "application/json"
	} else {
		values := url.Values{}
		for k, v := range data {
			values.Set(k, v.(string))
		}
		body = values.Encode()
		mime = "application/x-www-form-urlencoded"
	}

	signStr := apiPath + "\n" + body
	hmacObj := hmac.New(sha1.New, []byte(SecretKey))
	hmacObj.Write([]byte(signStr))
	sign := hex.EncodeToString(hmacObj.Sum(nil))
	Authorization := "TOKEN " + AccessKey + ":" + sign

	req, err := http.NewRequest("POST", "https://api.dogecloud.com"+apiPath, strings.NewReader(body))
	if err != nil {
		fmt.Printf("http request failed : %v\n", err)
	}
	req.Header.Add("Content-Type", mime)
	req.Header.Add("Authorization", Authorization)
	client := http.Client{}
	resp, err := client.Do(req)
	if err != nil {
		log.Fatalln(err)
	} // ç½‘ç»œé”™è¯¯
	defer resp.Body.Close()
	r, err := ioutil.ReadAll(resp.Body)
	if err != nil {
		fmt.Printf("read body failed : %v\n", err)
	}
	json.Unmarshal([]byte(r), &ret)

	return
}

func GetS3Client() *s3.S3 {
	prof := make(map[string]interface{})
	prof["channel"] = "OSS_FULL"
	prof["scopes"] = [1]string{"*"}
	r := DogeCloudAPI("/auth/tmp_token.json", prof, true)
	data := r["data"].(map[string]interface{})
	creds := data["Credentials"].(map[string]interface{})
	s3Config := &aws.Config{
		Credentials: credentials.NewStaticCredentials(creds["accessKeyId"].(string), creds["secretAccessKey"].(string), creds["sessionToken"].(string)),
		Region:      aws.String("automatic"),
		Endpoint:    aws.String("https://cos.ap-shanghai.myqcloud.com"), // ä¿®æ”¹ä¸ºå¤šå‰äº‘æ§åˆ¶å°å­˜å‚¨ç©ºé—´ SDK å‚æ•°ä¸­çš„ s3Endpoint
	}
	newSession, err := session.NewSession(s3Config)
	if err != nil {
		panic(fmt.Errorf("åˆå§‹åŒ–s3å®¢æˆ·ç«¯å¤±è´¥: %v\n", err))
	}
	return s3.New(newSession)
}
```

æˆ‘æŠŠè¿™ä¸ªæœåŠ¡æ„å»ºä¸ºä¸€ä¸ªé•œåƒï¼Œç„¶åæ¯æ¬¡ç”µè„‘çš„ docker å¯åŠ¨ä¹‹åå°±ä¼šè‡ªåŠ¨è¿è¡Œï¼š

```sh
docker run -itd --name doge -p 666:666 doge
```

æ­¤æ—¶æœ¬åœ°å°±ä¼šæœ‰ä¸ª 666 ç«¯å£çš„ç›‘å¬ã€‚

### è‡ªå®šä¹‰ä¸Šä¼ çš„é…ç½®

è¿™é‡Œç›´æ¥é€šè¿‡ä¸€å¼ æˆªå›¾æ¥å±•ç°é…ç½®çš„è¯¦ç»†å†…å®¹ï¼š

![1688811635060](https://t.eryajf.net/imgs/2023/07/1688811635060.png)

1. é¦–å…ˆæ–°å»ºä¸€ä¸ªé…ç½®ï¼Œé€‰æ‹©è‡ªå®šä¹‰ç±»å‹ã€‚
2. å¦‚æœä½ ä¹Ÿæ˜¯åœ¨æœ¬åœ°è¿è¡Œï¼Œåˆ™å¯ä»¥å¡«å†™ä¸ºï¼š `http://localhost:666/upload`
3. è¯¥æ¥å£ä¸º POST è¯·æ±‚ã€‚
4. æ–‡ä»¶å­—æ®µåä¸ºï¼šsourceï¼Œå†™æ­»ä¸è¦æ›´æ”¹ã€‚
5. è¿™é‡Œç‚¹å‡»å…¶ä»–å­—æ®µï¼Œè¦åœ¨ header ä¸­å¢åŠ ä¸€ä¸‹è¯·æ±‚ç±»å‹ï¼Œ`keyï¼šcontent-type`ï¼Œ`valueï¼šmultipart/form-data; charset=utf-8;`
6. æ­¤å¤„ä¸ºå–æ–‡ä»¶çš„å­˜æ”¾è·¯å¾„ï¼Œå›ºå®šä¸º `["url"]`ï¼Œä¸è¦æ›´æ”¹ã€‚
7. æœ€ååŸŸååˆ™æ˜¯ä½ ç»‘å®šåœ¨å¤šå‰äº‘ä¸­çš„åŸŸåã€‚

å½“æˆ‘ä»¬ç‚¹å‡»éªŒè¯ï¼Œå¦‚æœè¿”å›äº†ä¸Šä¼ æˆåŠŸçš„æç¤ºï¼Œåˆ™è¯´æ˜æ•´ä¸ªé“¾è·¯é€šç•…äº†ï¼ŒuPic ä¹Ÿä¼šæŠŠå›¾ç‰‡çš„è·¯å¾„é€šè¿‡åŸŸåä¸è·¯å¾„æ‹¼æ¥èµ·æ¥è‡ªåŠ¨æ”¾åˆ°ç²˜è´´æ¿ã€‚

è¿™æ ·å°±å¯ä»¥æ„‰å¿«åœ°é€šè¿‡ uPic æ¥é«˜æ•ˆçš„å®Œæˆä¸å›¾åºŠçš„äº¤äº’äº†ã€‚


å¦‚æœä½ ä¹Ÿæƒ³è¿™æ ·æŠ˜è…¾ï¼Œé‚£å°±èµ¶å¿«è¡ŒåŠ¨èµ·æ¥å§ï¼Œé…ç½®è¿‡ç¨‹ä¸­æœ‰ä»»ä½•é—®é¢˜ï¼Œéƒ½å¯ä»¥åœ¨è¯„è®ºåŒºç•™è¨€ï¼Œæˆ‘çœ‹åˆ°ä¹‹åä¸€å®šä¹Ÿä¼šçŸ¥æ— ä¸è¨€ã€‚
