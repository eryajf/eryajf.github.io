---
title: MongoDBè‡ªå¢IDåœ¨golangä¸­çš„å®è·µ
date: 2022-03-18 15:41:30
permalink: /pages/383679/
categories: 
  - ç¼–ç¨‹ä¸–ç•Œ
  - Goç¼–ç¨‹ç¬”è®°
  - å¼€å‘æŠ€å·§
tags: 
  - MongoDB
titleTag: åŸåˆ›
description: MongoDBé»˜è®¤çš„IDä¸åƒMySQLé‚£æ ·çš„è‡ªå¢IDï¼Œå¦‚æœæƒ³è¦å®ç°è‡ªå¢IDï¼Œåˆ™éœ€è¦å€ŸåŠ©äºå¦ä¸€å¼ è¡¨å­˜æ”¾è¯¥è¡¨çš„IDï¼Œæ¯æ¬¡å­˜æ•°æ®çš„æ—¶å€™ï¼Œéœ€è¦é€šè¿‡findAndModifyæ–¹æ³•å¯¹è¿™ä¸ªIDè¿›è¡Œè·å–å¹¶åŠ 1ã€‚

---

MongoDBé»˜è®¤çš„IDä¸åƒMySQLé‚£æ ·çš„è‡ªå¢IDï¼Œå¦‚æœæƒ³è¦å®ç°è‡ªå¢IDï¼Œåˆ™éœ€è¦å€ŸåŠ©äºå¦ä¸€å¼ è¡¨å­˜æ”¾è¯¥è¡¨çš„IDï¼Œæ¯æ¬¡å­˜æ•°æ®çš„æ—¶å€™ï¼Œéœ€è¦é€šè¿‡findAndModifyæ–¹æ³•å¯¹è¿™ä¸ªIDè¿›è¡Œè·å–å¹¶åŠ 1ã€‚

## åŸç”ŸMongoDBè¯­å¥

```sql
$ db.ids.save({name:"user", next_id:NumberInt("0")});
```

åˆ›å»ºä¸€ä¸ªé›†åˆï¼Œä¸“é—¨å­˜å‚¨å…¶ä»–è¡¨çš„è‡ªå¢ä¿¡æ¯ï¼Œé»˜è®¤æ•°å­—ç±»å‹æ˜¯`int64`ï¼Œè¿™é‡Œé€šè¿‡`NumberInt()`æ–¹æ³•å°†å…¶æŒ‡å®šä¸º`int32`ã€‚

æŸ¥è¯¢è¯¥æ¡è®°å½•ï¼š

```sql
$ db.getCollection('ids').find({})
{
    "_id" : ObjectId("6234313fb503f6bf2433f4e4"),
    "name" : "user",
    "next_id" : 0
}
```

æ–°å¢ç”¨æˆ·çš„æ—¶å€™ï¼Œç›´æ¥è°ƒç”¨è·å–IDï¼š

```sql
$ db.user.save({
    _id: NumberInt(db.ids.findAndModify({
        update:{$inc:{'next_id':NumberInt("1")}},
        query:{"name":"user"},
        new:true
    }).next_id),
    username: "eryajf",
    site:"https://wiki.eryajf.net"
});
```

`æ³¨ï¼š`å› ä¸ºfindAndModifyæ˜¯ä¸€ä¸ªæ–¹æ³•å®Œæˆæ›´æ–°æŸ¥æ‰¾ä¸¤ä¸ªæ“ä½œï¼Œæ‰€ä»¥å…·æœ‰åŸå­æ€§ï¼Œå¤šçº¿ç¨‹ä¸ä¼šå†²çªã€‚

ç„¶åæŸ¥è¯¢è¯¥æ¡è®°å½•ï¼š

```sql
$ db.getCollection('user').find({})
{
    "_id" : 1,
    "username" : "eryajf",
    "site" : "https://wiki.eryajf.net"
}
```

![](http://t.eryajf.net/imgs/2022/03/188761962cdfaea3.jpg)

## golangçš„å®ç°

golangçš„å®ç°ä¸è¯­å¥å·®ä¸å¤šï¼Œè¿™é‡Œåªæ˜¯åšç¤ºä¾‹å±•ç¤ºï¼Œå…¶ä¸­çš„`GetDataID("user")`åœ¨å®é™…ç”Ÿäº§ä½¿ç”¨è¿‡ç¨‹ä¸­ï¼Œéœ€è¦ç¡®ä¿å¯¹å…¶é”™è¯¯è¿›è¡Œå¤„ç†ã€‚

```go
package main

import (
	"context"
	"fmt"
	"learnmongo/public"
	"log"
	"math/rand"
	"strconv"

	"go.mongodb.org/mongo-driver/bson"
	"go.mongodb.org/mongo-driver/mongo"
	"go.mongodb.org/mongo-driver/mongo/options"
)

var DB *mongo.Database

func init() {
	uri := "mongodb://root:123456@10.1.1.3:27017"
	if uri == "" {
		log.Fatal("You must set your 'MONGODB_URI' environmental variable. See\n\t https://docs.mongodb.com/drivers/go/current/usage-examples/#environment-variable")
	}
	client, err := mongo.Connect(context.TODO(), options.Client().ApplyURI(uri))
	if err != nil {
		panic(err)
	}
	DB = client.Database("class")
}

type UserMongo struct {
	ID    int32  `bson:"_id"`
	Name  string `bson:"name"`
	Phone string `bson:"phone"`
	Email string `bson:"email"`
}

func main() {
	defer func() {
		if err := public.InitDb().Disconnect(context.TODO()); err != nil {
			panic(err)
		}
	}()
	fmt.Println("start")
	table := DB.Collection("user") // æŒ‡å®šè¡¨åä¸ºuser

	_, err := table.InsertMany(context.TODO(), []interface{}{
		UserMongo{
			ID:    GetDataID("user"),
			Name:  "eryajf" + strconv.Itoa(rand.Intn(11)),
			Phone: strconv.Itoa(rand.Intn(11)),
			Email: strconv.Itoa(rand.Intn(5)) + "@qq.com",
		},
		UserMongo{
			ID:    GetDataID("user"),
			Name:  "liql" + strconv.Itoa(rand.Intn(11)),
			Phone: strconv.Itoa(rand.Intn(11)),
			Email: strconv.Itoa(rand.Intn(5)) + "@qq.com",
		},
	})
	if err != nil {
		fmt.Print(err)
		return
	}

	fmt.Println("endã€ŒğŸ‘‹ã€")
}

func GetDataID(collname string) int32 {
	table := DB.Collection("ids") // æŒ‡å®šè¡¨åä¸ºidsè¡¨
	var result struct {
		Name   string `json:"name" bson:"name"`
		NextID int32  `json:"next_id" bson:"next_id"`
	}
	table.FindOneAndUpdate(
		context.TODO(),
		bson.M{"name": collname},
		bson.M{"$inc": bson.M{"next_id": 1}}).Decode(&result)
	return result.NextID
}
```

è‡ªå¢IDä»è§†è§‰ä¸Šæ›´åŠ ç›´è§‚ï¼Œä¸DBäº¤äº’æŸ¥è¯¢çš„æ—¶å€™ä¹Ÿæ›´åŠ ç®€ä¾¿ï¼ŒæŸäº›åœºæ™¯ä¸­æ˜¯å¯å–çš„æ–¹æ¡ˆã€‚

- å‚è€ƒï¼š[Mongodb è‡ªåŠ¨å¢é•¿ è‡ªå¢id å®ç°](http://www.dotcoo.com/post-39.html)