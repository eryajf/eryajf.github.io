---
title: å°†Jenkinså…±äº«åº“çš„Jenkinsfileæ”¾åˆ°cié™æ€æ£€æµ‹çš„å®è·µ
titleTag: åŸåˆ›
date: 2021-08-28 15:29:19
permalink: /pages/b732f5/
categories: 
  - ç³»åˆ—ä¸“é¢˜
  - Jenkinsç³»åˆ—æ–‡ç« 
tags: 
  - null

description: 
---

## 1ï¼Œå‰è¨€

æˆ‘ä»¬æ‰€æœ‰çš„æ„å»ºéƒ½å·²ç»æ‰˜ç®¡åœ¨Jenkinsä¸Šï¼ŒJenkinsæ‰€æœ‰çš„Jobéƒ½é‡‡ç”¨çš„pipelineå½¢å¼ï¼Œpipelineæ‰€æœ‰çš„å¼•å¯¼æ–‡ä»¶éƒ½å·²ç»æ‰˜ç®¡åœ¨gitlabç»Ÿä¸€è°ƒç”¨å…±äº«åº“ï¼Œå…±äº«åº“ä¹Ÿéƒ½æ‰˜ç®¡åœ¨gitlabåƒæ™®é€šé¡¹ç›®é‚£æ ·èµ°å¼€å‘-reviewçš„æµç¨‹è¿›è¡Œä¸Šçº¿ã€‚

butï¼Œæœ‰ä¸€ä¸ªé—®é¢˜æ˜¯ï¼Œå…±äº«åº“è¿™ç§æçº²æŒˆé¢†çš„ï¼Œä»¥ä¸€æŒä¸‡çš„ï¼Œçº²ä¸¾ç›®å¼ çš„å­˜åœ¨ï¼Œåˆ°å¦‚ä»Šéƒ½è¿˜æ²¡æœ‰èµ°ä¸¥æ ¼æ„ä¹‰ä¸Šçš„å¼€å‘æµç¨‹ã€‚äº‹å®ä¸Šå‰å‡ å¤©å·²ç»åƒè¿‡è¿™ç§äºäº†ï¼Œä¸€ä¸ªè´¡çŒ®åº“æ–‡ä»¶è¢«ä¸Šç™¾ä¸ªå‘å¸ƒjobå¼•ç”¨éå¸¸å¸¸è§ï¼Œè€Œå› ä¸ºè¿ç»´åŒå­¦ç¨ç¨ç²—å¿ƒï¼Œå°‘äº†ä¸ªåå…³é—­çš„å¤§æ‹¬å·ï¼Œpushåˆ°å…±äº«åº“ä¹‹åå°±ä¸‹ç­èµ°äººäº†ï¼Œç»“æœå½±å“äº†ä¸å°‘é¡¹ç›®çš„æ„å»ºã€‚è€Œè¿™ç§æ¯”è¾ƒä½çº§çš„é”™è¯¯ï¼Œæœ¬æ¥å¯ä»¥é€šè¿‡å‰ç½®å·¥ä½œè¿›è¡Œä¸€äº›æ£€æµ‹çš„ã€‚

## 2ï¼Œè°ƒç ”

ä»Šå¤©å°±æ¥åšä¸€ä¸‹å…±äº«åº“å†…ä¸»è¦å‘å¸ƒé€»è¾‘è„šæœ¬çš„è¯­æ³•é™æ€æ£€æµ‹ï¼Œçœ‹äº†ä¸€ä¸‹ï¼Œç½‘ä¸Šæœ‰ä¸å°‘çš„ç›¸å…³èµ„æ–™ï¼Œæ•´ç†å¦‚ä¸‹ï¼š

- [Jenkinså®˜æ–¹æ–‡æ¡£â€“ç®¡é“å¼€å‘å·¥å…·](https://www.jenkins.io/doc/book/pipeline/development/)
- stack overflow
  - [Jenkins: How do I lint Jenkins pipelines from the command line?](https://stackoverflow.com/questions/44703012/jenkins-how-do-i-lint-jenkins-pipelines-from-the-command-line)
- [jflint](https://github.com/miyajan/jflint)
  - ä¸€ä¸ªå¼€æºçš„æ£€æµ‹å·¥å…·ï¼Œä½¿ç”¨ç›¸å½“ç®€ä¾¿ï¼Œæœ¬æ–‡ä½¿ç”¨è¿™ä¸ªã€‚
- [npm-groovy-lint](https://github.com/nvuillam/npm-groovy-lint)
  - åŒæ ·æ˜¯ä¸€ä¸ªæ£€æµ‹å·¥å…·ï¼Œçœ‹èµ·æ¥åŠŸèƒ½æ›´å¼ºå¤§ï¼Œæœ‰ç‚¹å¤æ‚ã€‚

## 3ï¼Œå‡†å¤‡

æœ‰äº†å¦‚ä¸Šä»‹ç»ä»¥åŠæ–‡æ¡£åŸºç¡€ä¹‹åï¼Œæˆ‘ä»¬é€‰æ‹©jflintè¿™ä¸ªå·¥å…·æ¥è¿›è¡Œæ£€æµ‹ï¼Œç»“åˆ [jenkinsä½œä¸ºciæ£€æµ‹ä»£ç æ˜¯å¦åˆå¹¶çš„å®è·µ](https://wiki.eryajf.net/pages/615b71/#_1-gitlab%E9%85%8D%E7%BD%AE)æ­¤æ–‡ç« é…ç½®æµæ°´çº¿ciï¼Œå°†å…±äº«åº“æ‰˜ç®¡èµ·æ¥ã€‚

ç”±äºå¦‚ä¸Šå·¥å…·æ²¡æœ‰ç›´æ¥ç»™åˆ°å®¹å™¨åŒ–çš„ç‰ˆæœ¬ï¼Œæ‰€ä»¥æˆ‘è¿™é‡Œæ„å»ºä¸€ä¸ªå®¹å™¨ï¼Œè¯»è€…å¯ä»¥ç›´æ¥æ‹¿å»ä½¿ç”¨ï¼š

- å®˜æ–¹ï¼š`eryajf/jflint`
- å›½å†…ï¼š`registry.cn-hangzhou.aliyuncs.com/ali_eryajf/jflint`

ç®€å•æŸ¥çœ‹ï¼š

```bash
$ docker run -it  eryajf/jflint  jflint -h
Usage: jflint [options] Jenkinsfile

Options:
  -v, --version                output the version number
  -j, --jenkins-url <url>      Jenkins URL
  -u, --username <username>    Username for Jenkins
  -p, --password <password>    Password or API Token for Jenkins
  --csrf-disabled              Specify if CSRF prevention is disabled on Jenkins
  -c, --config <path>          Path to config json file
  --ssl-verification-disabled  Disable SSL verification
  -h, --help                   output usage information
```

å…¶ä¸­åœ¨æ„å»ºé•œåƒæ—¶ï¼Œå£°æ˜äº†ä¸¤ä¸ªENVï¼Œä»¥ä¾¿äºè°ƒç”¨ï¼š

```bash
ENV USER=admin
ENV PASS=admin
```

## 4ï¼ŒéªŒè¯

æ­¤æ—¶å‡†å¤‡ä¸€ä¸ªéå¸¸ç®€å•çš„æµæ°´çº¿ä½œä¸ºæµ‹è¯•ä½¿ç”¨ï¼š

```bash
cat >> test.jenkins << 'EOF'
pipeline {
    agent any
    environment {
        // è¾“å‡ºç»“æœä¸º 20200330142150_4
        _version = sh(script: "echo `date '+%Y%m%d%H%M%S'`" + "_${env.BUILD_ID}", returnStdout: true).trim()
    }
    stages {
        stage ("test") {
            steps {
                echo "${_version}"
            }
        }
    }
}
EOF
```

ç„¶åè¿è¡Œå¦‚ä¸‹å‘½ä»¤è¿›è¡Œæ£€æµ‹ï¼š

```bash
$ docker run -itd --name jflint eryajf/jflint # å¦‚æœä½ çš„ç”¨æˆ·åå¯†ç å¹¶ä¸æ˜¯ä¸Šè¾¹ä¸¤ä¸ªï¼Œå¯ä»¥é€šè¿‡-eè¿›è¡Œè¦†ç›–
$ docker cp test.jenkins jflint:/opt
$ docker exec -it jflint jflint -u $USER -p $PASS -j https://ci.test.com /opt/test.jenkins
Jenkinsfile successfully validated.
```

æ­¤æ—¶å°†å¦‚ä¸Šæµæ°´çº¿è¿›è¡Œç®€å•è°ƒæ•´ï¼š

```groovy
cat >> test.jenkins << 'EOF'
pipeline {
    agent any
    environment {
        // è¾“å‡ºç»“æœä¸º 20200330142150_4
        _version = sh(script: "echo `date '+%Y%m%d%H%M%S'`" + "_${env.BUILD_ID}", returnStdout: true).trim()
    }
    stages {
        stage ("test") {
            steps {
                echo "${_version}"
            }
        }
    }
EOF
```

`æ³¨æ„åˆ é™¤äº†æœ€åä¸€è¡Œçš„æ‹¬å·ã€‚`

ç„¶åå†æ¬¡è¿è¡Œæ£€æµ‹ï¼š

```bash
$ docker exec -it jflint jflint -u $USER -p $PASS -j https://ci.test.com /opt/test.jenkins
Errors encountered validating Jenkinsfile:
WorkflowScript: 14: expecting '}', found '' @ line 14, column 1.
```

å¯ä»¥çœ‹åˆ°ä¸ä»…æŠ¥é”™äº†ï¼Œè¿˜æç¤ºäº†æˆ‘ä»¬é”™è¯¯çš„è¡Œæ•°ï¼Œå¯ä»¥è¯´éå¸¸æ¸…æ™°äº†ã€‚

![11](http://t.eryajf.net/imgs/2021/09/b38526bc56ae4df1.jpg)

## 5ï¼Œå®è·µ

æœ‰äº†å¦‚ä¸Šå‡†å¤‡ä»¥åŠå®éªŒä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥ç›´æ¥æ·»åŠ å¦‚ä¸‹æµæ°´çº¿ï¼Œä½œä¸ºé™æ€ciçš„é…ç½®ä¿¡æ¯ï¼š

```groovy
pipeline {
    agent any
    environment {
        // æœåŠ¡åç§°
        SERVICE_NAME="${JOB_BASE_NAME}"
        MODE="DEPLOY"
        REASON="æ— "
        REMOTE_HOST="å ä½"
        _VERSION="æµ‹è¯•éªŒè¯"
        ROBOT_KEY="6a781aaf-0cda-41ab-9bd2-ed81ee7fc7"
        // ä¸»é¡¹ç›®åœ°å€
        GIT_URL = "https://gitlab.test.com/jenkins/shared-library.git"
    }
    parameters {
        string(name: 'BRANCH', defaultValue: 'master', description: 'è¯·è¾“å…¥å°†è¦æ„å»ºçš„ä»£ç åˆ†æ”¯')
    }
    options {
        timestamps() // è¾“å‡ºæ„å»ºæ—¥å¿—æ‰“å°æ—¶é—´ä¿¡æ¯
        timeout(time: 10, unit: 'MINUTES') // è®¾ç½®æ„å»ºè¶…æ—¶æ—¶é—´
        buildDiscarder(logRotator(numToKeepStr: '15')) // è®¾ç½®å†å²æ„å»ºä¿ç•™æ¬¡æ•°
        gitLabConnection('gitlab-token') // æ“ä½œgitlabçš„token
    }
    triggers{
        gitlab(
            triggerOnPush: false,
            triggerOnMergeRequest: true,
            branchFilterType: 'All',
            secretToken: "${env.GIT_TOKEN}"
        ) // é¢„ç•™Gitlabæäº¤è‡ªåŠ¨æ„å»º
    }
    stages {
        stage('ç½®ä¸ºpending') {
            steps {
                script {
                    try {
                        updateGitlabCommitStatus name: 'build', state: 'pending'
                    }catch(exc) {
                        env.REASON = "ç½®ä¸ºpendingå‡ºé”™"
                        throw(exc)
                    }
                }
            }
        }
        stage('æ‹‰å–ä»£ç ') {
            steps {
                script {
                    try {
                        env.CAUSE = currentBuild.getBuildCauses()[0].(userId)
                        if ("${CAUSE}" == 'null') {
                            env.BRANCH = sh(script: 'echo ${gitlabBranch}',  returnStdout: true).trim()
                        }
                        checkout(
                            [$class: 'GitSCM', doGenerateSubmoduleConfigurations: false, submoduleCfg: [], extensions: [[$class: 'CloneOption', depth: 1, noTags: false, reference: '', shallow: true]],
                            branches: [[name: "$BRANCH"]],userRemoteConfigs: [[url: "${env.GIT_URL}", credentialsId: "cicd-pass"]]]
                        )
                        // å®šä¹‰å…¨å±€å˜é‡
                        env.COMMIT_ID   = sh(script: 'git log --pretty=format:%h',  returnStdout: true).trim() // æäº¤ID
                        env.COMMIT_USER = sh(script: 'git log --pretty=format:%an', returnStdout: true).trim() // æäº¤è€…
                        env.COMMIT_TIME = sh(script: 'git log --pretty=format:%ai', returnStdout: true).trim() // æäº¤æ—¶é—´
                        env.COMMIT_INFO = sh(script: 'git log --pretty=format:%s',  returnStdout: true).trim() // æäº¤ä¿¡æ¯
                    }catch(exc) {
                        env.REASON = "æ‹‰å–ä»£ç å‡ºé”™"
                        throw(exc)
                    }
                }
            }
        }
        stage('æ£€æµ‹é¡¹ç›®') {
            steps {
                script {
                    try {
                        docker.image('eryajf/jflint').inside("-e USER=admin -e PASS=admin12345") {
                            sh '''
                                for i in `ls vars`;do
                                    jflint -u $USER -p $PASS -j https://ci.test.com vars/$i
                                done
                            '''
                        }
                        sh "printenv"
                    }catch(exc) {
                        env.REASON = "æ£€æµ‹é¡¹ç›®å‡ºé”™"
                        throw(exc)
                    }
                }
            }
        }
    }
    post {
        always {
            script{
                wrap([$class: 'BuildUser']){
                    buildName "#${BUILD_ID}-${BRANCH}-${BUILD_USER}" // æ›´æ”¹æ„å»ºåç§°
                    currentBuild.description = "æäº¤è€…: ${COMMIT_USER}" // æ·»åŠ è¯´æ˜ä¿¡æ¯
                    currentBuild.description += "\næ„å»ºä¸»æœº: ${REMOTE_HOST}" // æ·»åŠ è¯´æ˜ä¿¡æ¯
                    currentBuild.description += "\næäº¤ID: ${COMMIT_ID}" // æ·»åŠ è¯´æ˜ä¿¡æ¯
                    currentBuild.description += "\næäº¤æ—¶é—´: ${COMMIT_TIME}" // æ·»åŠ è¯´æ˜ä¿¡æ¯
                    currentBuild.description += "\næäº¤å†…å®¹: ${COMMIT_INFO}" // æ·»åŠ è¯´æ˜ä¿¡æ¯
                }
                sh "printenv"
            }
            cleanWs()
        }
        success {
            updateGitlabCommitStatus(name: 'build', state: 'success')
            addGitLabMRComment comment: "ğŸ¤–Jenkins ci check successğŸ¥³, see the log: ${BUILD_URL}console"
        }
        failure {
            updateGitlabCommitStatus(name: 'build', state: 'failed')
            addGitLabMRComment comment: "ğŸ¤–Jenkins ci check failedğŸ¤¯, see the log: ${BUILD_URL}console"
        }
    }
}
```

æ³¨æ„ï¼ŒåŸºäºå®¹å™¨è¿è¡Œçš„æ—¶å€™ï¼Œå¯ä»¥é€šè¿‡åè¾¹çš„å‚æ•°æ¥æŒ‡å®šè‡ªå·±çš„ç”¨æˆ·åä¿¡æ¯ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥ä½¿ç”¨tokençš„æ–¹å¼ã€‚

è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥æŠŠå…±äº«åº“çš„ç»´æŠ¤ï¼Œèµ°ç±»ä¼¼å¸¸è§„é¡¹ç›®å¼€å‘çš„æµç¨‹ï¼Œé€šè¿‡checkæ™®é€šåˆ†æ”¯ï¼Œèµ°mergeçš„æ–¹å¼ï¼Œå¹¶ä¸”æœ‰é™æ€è‡ªåŠ¨æ£€æµ‹è¯­æ³•ï¼ŒæˆåŠŸä¹‹åæ–¹å¯åˆå¹¶åˆ°ä¸»å¹²åˆ†æ”¯ï¼Œä»¥æœŸå°†å½±å“é™åˆ°æœ€ä½ã€‚