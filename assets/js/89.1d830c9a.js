(window.webpackJsonp=window.webpackJsonp||[]).push([[89],{433:function(s,t,a){"use strict";a.r(t);var e=a(0),n=Object(e.a)({},(function(){var s=this,t=s._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h2",{attrs:{id:"操作"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#操作"}},[s._v("#")]),s._v(" 操作")]),s._v(" "),t("p",[s._v("由于部署初期预估不足，使得 confluence 的应用数据写到了根分区当中，而根分区又只有 50G，现在附件越来越多，眼见磁盘将满，有句俗话说的好：我不来解决，谁又来解决！")]),s._v(" "),t("p",[s._v("事情可能不复杂，但是操作一旦出纰漏，也是非常重大的，因此写好操作流程，按章施工，以免出错。")]),s._v(" "),t("ol",[t("li",[t("p",[s._v("发出维护通知，在夜深无人时操作。")])]),s._v(" "),t("li",[t("p",[s._v("先停止 NGINX，切断所有请求，以免有新的文章附件编辑提交。")])]),s._v(" "),t("li",[t("p",[s._v("提前将数据同步到将要迁移的目录之下，命令如下：\n"),t("code",[s._v("rsync -avz --delete /var/atlassian/ /confluence/atlassian/")])])]),s._v(" "),t("li",[t("p",[s._v("操作之前，记得再次执行如上命令，以保证数据一致。")])]),s._v(" "),t("li",[t("p",[s._v("停止 confluence 服务，使用如下命令：\n"),t("code",[s._v("/opt/atlassian/confluence/bin/shutdown.sh")])])]),s._v(" "),t("li",[t("p",[s._v("编辑 confluence 配置文件，更改如下内容：")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("vim")]),s._v(" /opt/atlassian/confluence/confluence/WEB-INF/classes/confluence-init.properties\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 改写如下配置文件的路径为迁移后的路径")]),s._v("\nconfluence.home "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" /var/atlassian/application-data/confluence\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])])]),s._v(" "),t("li",[t("p",[s._v("启动 confluence，命令如下：\n"),t("code",[s._v("/opt/atlassian/confluence/bin/startup.sh")])])]),s._v(" "),t("li",[t("p",[s._v("查看日志，启动是否有异常，如果没有问题，可以将 NGINX 启动。")])])]),s._v(" "),t("p",[t("code",[s._v("注意启停命令不能用start/stop，否则会失败!")])]),s._v(" "),t("p",[t("img",{attrs:{src:"http://t.eryajf.net/imgs/2021/09/6ef7c2de8232eb57.jpg",alt:"img"}})]),s._v(" "),t("div",{staticClass:"custom-block note"},[t("p",{staticClass:"custom-block-title"},[s._v("申明")]),s._v(" "),t("p",[t("strong",[s._v("原创文章"),t("Badge",{attrs:{text:"eryajf"}}),s._v("，未经授权，严禁转载，侵权必究！此乃文中随机水印，敬请读者谅解。")],1)]),s._v(" "),t("div",{staticClass:"custom-block right"},[t("p",[s._v("Copyright "),t("a",{attrs:{href:"https://wiki.eryajf.net",target:"_blank",rel:"noopener noreferrer"}},[s._v("二丫讲梵"),t("OutboundLink")],1),s._v(" 版权所有")])])]),s._v(" "),t("ol",{attrs:{start:"9"}},[t("li",[s._v("访问服务，验证功能是否正常。")])]),s._v(" "),t("p",[t("code",[s._v("注意")]),s._v("：如果相关权限不正确，可能会导致部分功能加载失败，比如我迁移完成之后，发现编辑页面的"),t("code",[s._v("其他宏")]),s._v("功能点击无法正常使用，此时对比了老目录的权限，分别调整了属主属组，好像还不行，最后通过将 plugin 开头的目录全部给了 777 的权限(此操作可在服务运行期间执行,不必重启服务)，然后才能正常使用。")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" /confluence/atlassian/application-data/confluence/\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("chmod")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("777")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-R")]),s._v(" plugins-*\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("p",[s._v("再到页面，发现"),t("code",[s._v("其他宏")]),s._v("恢复使用。")]),s._v(" "),t("p",[s._v("加载失败的报错如下：")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("http://ex.confluence.com/plugins/macrobrowser/browse-macros.action?detailed"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("false¯oMetadataClientCacheKey"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1589232968441")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" and may be stuck "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("configured threshold "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" this StuckThreadDetectionValve is "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("60")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" seconds"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(". There is/are "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("15")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" thread"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("s"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" total that are monitored by this Valve and may be stuck.\n java.lang.Throwable\n        at java.net.PlainSocketImpl.socketConnect"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("Native Method"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("h2",{attrs:{id:"补充"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#补充"}},[s._v("#")]),s._v(" 补充")]),s._v(" "),t("p",[s._v("后来再经过几次迁移实践之后发现，confluence 启动之后，编辑文章时插入目录或者其他宏的确是无法使用的，而大约等个二十分钟左右之后，该功能正常，目前怀疑可能是服务启动之后会有一些之后的任务跑了之后，某些功能才能正常使用。")]),s._v(" "),t("p",[s._v("因此在操作迁移之类的工作时，要有一定的耐心来等待这个事情，同时也提供了一个经验：一些服务我们在运维维护的时候，通知出去的维护窗口应该尽可能大，比如你觉得只是简单的变更维护，十分钟足够了，然而当你重启之后，发现此功能无法正常使用，却只能回滚，没能达到变更的目的，但服务只不过是需要一些初始化的时间。")])])}),[],!1,null,null,null);t.default=n.exports}}]);