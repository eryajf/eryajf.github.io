(window.webpackJsonp=window.webpackJsonp||[]).push([[107],{448:function(t,e,_){"use strict";_.r(e);var n=_(0),s=Object(n.a)({},(function(){var t=this,e=t._self._c;return e("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[e("h2",{attrs:{id:"_1-前言。"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_1-前言。"}},[t._v("#")]),t._v(" 1，前言。")]),t._v(" "),e("p",[t._v("风平浪静的下午，一个前端开发同事找到我，说感觉好像 nginx 那边有一些转发并没有到达后端。")]),t._v(" "),e("p",[t._v("我问，怎么了？")]),t._v(" "),e("p",[t._v("她说的也非常具体，第一是常规访问服务，然后返回的状态是 401，提示令牌失效（"),e("code",[t._v("Token Invalid")]),t._v(" ）。接着直接访问后端所代理的服务，然后就是正常的。")]),t._v(" "),e("p",[t._v("哦，听上去很明显啦，事儿就是到 nginx 这里卡住了呗。我问她详细的情况是怎样的？")]),t._v(" "),e("p",[t._v("她说获取验证码以及登陆都是没有问题的，但是就是这里的 token 没有传过去，token 是放在请求头里边的，这个头的名称是“"),e("code",[t._v("old_token")]),t._v("”。")]),t._v(" "),e("p",[t._v("听上去一切好像都没什么问题，而这个问题也确实是我第一次遇到的，后来求助百度，在某篇文章里找到了答案，这里粘贴过来，以存记录。")]),t._v(" "),e("p",[e("img",{attrs:{src:"http://t.eryajf.net/imgs/2021/09/de6d2228a3d8cc36.jpg",alt:"image"}})]),t._v(" "),e("div",{staticClass:"custom-block note"},[e("p",{staticClass:"custom-block-title"},[t._v("申明")]),t._v(" "),e("p",[e("strong",[t._v("原创文章"),e("Badge",{attrs:{text:"eryajf"}}),t._v("，未经授权，严禁转载，侵权必究！此乃文中随机水印，敬请读者谅解。")],1)]),t._v(" "),e("div",{staticClass:"custom-block right"},[e("p",[t._v("Copyright "),e("a",{attrs:{href:"https://wiki.eryajf.net",target:"_blank",rel:"noopener noreferrer"}},[t._v("二丫讲梵"),e("OutboundLink")],1),t._v(" 版权所有")])])]),t._v(" "),e("h2",{attrs:{id:"_2-解决。"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_2-解决。"}},[t._v("#")]),t._v(" 2，解决。")]),t._v(" "),e("p",[t._v("原本在测试环境测试通过的 APP，今天准备切到线上环境做最后测试，结果发现了错误。查看日志发现是 APP 端发送的 http 请求中的 header 内容丢失了。那么代码没有改动，怎么平白无故会丢失头信息？")]),t._v(" "),e("p",[t._v("于是想到两个环境的不同之处在于线上是通过 nginx 做的代理转发，会不会是 nginx 搞的鬼？于是搜索“nginx request header 丢失”，果不其然是这个问题，nginx 对下划线的头信息做了限制，找到问题所在就等于完成了一大半，办法总比困难多。遂决定记录之。")]),t._v(" "),e("h3",{attrs:{id:"_2-1-不用下划线-。"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-不用下划线-。"}},[t._v("#")]),t._v(" 2.1 不用下划线 。")]),t._v(" "),e("p",[t._v("既然 nginx 对下划线不支持，那没关系，不用下划线就是了。比如原来"),e("code",[t._v("old_token")]),t._v("改成"),e("code",[t._v("old-token")]),t._v("就可以了。（难怪一般 header 的 name 都是"),e("code",[t._v("-")]),t._v("来拼接的，比如"),e("code",[t._v("User-Agent")]),t._v("） 。")]),t._v(" "),e("h3",{attrs:{id:"_2-2-从根本上解除-nginx-的限制-。"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-从根本上解除-nginx-的限制-。"}},[t._v("#")]),t._v(" 2.2 从根本上解除 nginx 的限制 。")]),t._v(" "),e("p",[t._v("nginx 默认 request 的 header 的那么中包含"),e("code",[t._v("_")]),t._v("时，会自动忽略掉。")]),t._v(" "),e("p",[t._v("解决方法是：在 nginx 里的 nginx.conf 配置文件中的 http 部分中添加如下配置：")]),t._v(" "),e("div",{staticClass:"language-sh line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[t._v("underscores_in_headers on"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br")])]),e("p",[e("code",[t._v("默认 underscores_in_headers 为off")]),t._v("。")]),t._v(" "),e("p",[t._v("我们采取了第一种方法，她更改了一下请求头的名称，果然这个问题就解决了。")]),t._v(" "),e("p",[t._v("参考链接：https://blog.csdn.net/Nazir2513/article/details/70889319")])])}),[],!1,null,null,null);e.default=s.exports}}]);