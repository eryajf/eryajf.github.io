(window.webpackJsonp=window.webpackJsonp||[]).push([[423],{765:function(s,t,e){"use strict";e.r(t);var a=e(0),n=Object(a.a)({},(function(){var s=this,t=s._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("p",[s._v("kublet 运行在每个 worker 节点上，接收 kube-apiserver 发送的请求，管理 Pod 容器，执行交互式命令，如 exec、run、logs 等。")]),s._v(" "),t("p",[s._v("kublet 启动时自动向 kube-apiserver 注册节点信息，内置的 cadvisor 统计和监控节点的资源使用情况。")]),s._v(" "),t("p",[s._v("为确保安全，本文档只开启接收 https 请求的安全端口，对请求进行认证和授权，拒绝未授权的访问 (如 apiserver、heapster)。")]),s._v(" "),t("p",[s._v("下载分发，在部署 master 节点时已经做过，依赖包也在 work 节点当中安装过，现在直接进入配置。")]),s._v(" "),t("h2",{attrs:{id:"_1-创建-kubelet-bootstrap-kubeconfig-文件"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-创建-kubelet-bootstrap-kubeconfig-文件"}},[s._v("#")]),s._v(" 1，创建 kubelet bootstrap kubeconfig 文件")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" magic.sh "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<<")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"EOF"\n#!/bin/bash\nsource /opt/k8s/bin/environment.sh\nfor node_name in ${NODE_NAMES[@]}\ndo\n    echo ">>> ${node_name}"\n    # 创建 token\n    export BOOTSTRAP_TOKEN=$(kubeadm token create \\\n      --description kubelet-bootstrap-token \\\n      --groups system:bootstrappers:${node_name} \\\n      --kubeconfig ~/.kube/config)\n    # 设置集群参数\n    kubectl config set-cluster kubernetes \\\n      --certificate-authority=/etc/kubernetes/cert/ca.pem \\\n      --embed-certs=true \\\n      --server=${KUBE_APISERVER} \\\n      --kubeconfig=kubelet-bootstrap-${node_name}.kubeconfig\n    # 设置客户端认证参数\n    kubectl config set-credentials kubelet-bootstrap \\\n      --token=${BOOTSTRAP_TOKEN} \\\n      --kubeconfig=kubelet-bootstrap-${node_name}.kubeconfig\n    # 设置上下文参数\n    kubectl config set-context default \\\n      --cluster=kubernetes \\\n      --user=kubelet-bootstrap \\\n      --kubeconfig=kubelet-bootstrap-${node_name}.kubeconfig\n    # 设置默认上下文\n    kubectl config use-context default --kubeconfig=kubelet-bootstrap-${node_name}.kubeconfig\ndone\nEOF')]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br"),t("span",{staticClass:"line-number"},[s._v("30")]),t("br")])]),t("ul",[t("li",[s._v("证书中写入 Token 而非证书，证书后续由 controller-manager 创建。")])]),s._v(" "),t("p",[s._v("查看 kubeadm 为各节点创建的 token：")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$kubeadm")]),s._v(" token list "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--kubeconfig")]),s._v(" ~/.kube/config\nTOKEN                     TTL       EXPIRES                     USAGES                   DESCRIPTION               EXTRA "),t("span",{pre:!0,attrs:{class:"token environment constant"}},[s._v("GROUPS")]),s._v("\n3v99js.8f7hy9cid9olxx23   17h       "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2018")]),s._v("-11-24T18:55:13+08:00   authentication,signing   kubelet-bootstrap-token   system:bootstrappers:kube-node2\n904crw.exhwgn907b8zuzgz   17h       "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2018")]),s._v("-11-24T18:55:13+08:00   authentication,signing   kubelet-bootstrap-token   system:bootstrappers:kube-node3\nv75f7h.6516uqw5g4yttcqj   17h       "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2018")]),s._v("-11-24T18:55:13+08:00   authentication,signing   kubelet-bootstrap-token   system:bootstrappers:kube-node1\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br")])]),t("ul",[t("li",[s._v("创建的 token 有效期为 1 天，超期后将不能再被使用，且会被 kube-controller-manager 的 tokencleaner 清理 (如果启用该 controller 的话)；")]),s._v(" "),t("li",[s._v("kube-apiserver 接收 kubelet 的 bootstrap token 后，将请求的 user 设置为 system:bootstrap:，group 设置为 system:bootstrappers；")])]),s._v(" "),t("p",[s._v("各 token 关联的 Secret：")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$kubectl")]),s._v(" get secrets  "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-n")]),s._v(" kube-system\nNAME                                             TYPE                                  DATA      AGE\nbootstrap-token-3v99js                           bootstrap.kubernetes.io/token         "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("7")]),s._v("         6h\nbootstrap-token-904crw                           bootstrap.kubernetes.io/token         "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("7")]),s._v("         6h\nbootstrap-token-v75f7h                           bootstrap.kubernetes.io/token         "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("7")]),s._v("         6h\ndefault-token-sqk8s                              kubernetes.io/service-account-token   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("         6h\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br")])]),t("h2",{attrs:{id:"_2-分发-bootstrap-kubeconfig-文件到所有-worker-节点"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-分发-bootstrap-kubeconfig-文件到所有-worker-节点"}},[s._v("#")]),s._v(" 2，分发 bootstrap kubeconfig 文件到所有 worker 节点")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" magic.sh "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<<")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"EOF"\n#!/bin/bash\nsource /opt/k8s/bin/environment.sh\nfor node_name in ${NODE_NAMES[@]}\ndo\n    echo ">>> ${node_name}"\n    scp kubelet-bootstrap-${node_name}.kubeconfig k8s@${node_name}:/etc/kubernetes/kubelet-bootstrap.kubeconfig\ndone\nEOF')]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br")])]),t("h2",{attrs:{id:"_3-创建和分发-kubelet-参数配置文件"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-创建和分发-kubelet-参数配置文件"}},[s._v("#")]),s._v(" 3，创建和分发 kubelet 参数配置文件")]),s._v(" "),t("p",[s._v("创建 kubelet 参数配置模板文件：")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$source")]),s._v(" /opt/k8s/bin/environment.sh\n"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$cat")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" kubelet.config.json.template "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<<")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('EOF\n{\n  "kind": "KubeletConfiguration",\n  "apiVersion": "kubelet.config.k8s.io/v1beta1",\n  "authentication": {\n    "x509": {\n      "clientCAFile": "/etc/kubernetes/cert/ca.pem"\n    },\n    "webhook": {\n      "enabled": true,\n      "cacheTTL": "2m0s"\n    },\n    "anonymous": {\n      "enabled": false\n    }\n  },\n  "authorization": {\n    "mode": "Webhook",\n    "webhook": {\n      "cacheAuthorizedTTL": "5m0s",\n      "cacheUnauthorizedTTL": "30s"\n    }\n  },\n  "address": "##NODE_IP##",\n  "port": 10250,\n  "readOnlyPort": 0,\n  "cgroupDriver": "cgroupfs",\n  "hairpinMode": "promiscuous-bridge",\n  "serializeImagePulls": false,\n  "featureGates": {\n    "RotateKubeletClientCertificate": true,\n    "RotateKubeletServerCertificate": true\n  },\n  "clusterDomain": "'),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${CLUSTER_DNS_DOMAIN}")]),s._v('",\n  "clusterDNS": ["'),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${CLUSTER_DNS_SVC_IP}")]),s._v('"]\n}\nEOF')]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br"),t("span",{staticClass:"line-number"},[s._v("30")]),t("br"),t("span",{staticClass:"line-number"},[s._v("31")]),t("br"),t("span",{staticClass:"line-number"},[s._v("32")]),t("br"),t("span",{staticClass:"line-number"},[s._v("33")]),t("br"),t("span",{staticClass:"line-number"},[s._v("34")]),t("br"),t("span",{staticClass:"line-number"},[s._v("35")]),t("br"),t("span",{staticClass:"line-number"},[s._v("36")]),t("br"),t("span",{staticClass:"line-number"},[s._v("37")]),t("br"),t("span",{staticClass:"line-number"},[s._v("38")]),t("br")])]),t("ul",[t("li",[s._v("address：API 监听地址，不能为 127.0.0.1，否则 kube-apiserver、heapster 等不能调用 kubelet 的 API；")]),s._v(" "),t("li",[s._v("readOnlyPort=0：关闭只读端口 (默认 10255)，等效为未指定；")]),s._v(" "),t("li",[s._v("authentication.anonymous.enabled：设置为 false，不允许匿名访问 10250 端口；")]),s._v(" "),t("li",[s._v("authentication.x509.clientCAFile：指定签名客户端证书的 CA 证书，开启 HTTP 证书认证；")]),s._v(" "),t("li",[s._v("authentication.webhook.enabled=true：开启 HTTPs bearer token 认证；")]),s._v(" "),t("li",[s._v("对于未通过 x509 证书和 webhook 认证的请求 (kube-apiserver 或其他客户端)，将被拒绝，提示 Unauthorized；")]),s._v(" "),t("li",[s._v("authroization.mode=Webhook：kubelet 使用 SubjectAccessReview API 查询 kube-apiserver 某 user、group 是否具有操作资源的权限 (RBAC)；")]),s._v(" "),t("li",[s._v("featureGates.RotateKubeletClientCertificate、featureGates.RotateKubeletServerCertificate：自动 rotate 证书，证书的有效期取决于 kube-controller-manager 的 –experimental-cluster-signing-duration 参数；")]),s._v(" "),t("li",[s._v("需要 root 账户运行；")])]),s._v(" "),t("p",[s._v("为各节点创建和分发 kubelet 配置文件：")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" magic.sh "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<<")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"EOF"\n#!/bin/bash\nsource /opt/k8s/bin/environment.sh\nfor node_ip in ${NODE_IPS[@]}\ndo\n    echo ">>> ${node_ip}"\n    sed -e "s/##NODE_IP##/${node_ip}/" kubelet.config.json.template > kubelet.config-${node_ip}.json\n    scp kubelet.config-${node_ip}.json root@${node_ip}:/etc/kubernetes/kubelet.config.json\ndone\nEOF')]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br")])]),t("h2",{attrs:{id:"_4-创建和分发-kubelet-systemd-unit-文件"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-创建和分发-kubelet-systemd-unit-文件"}},[s._v("#")]),s._v(" 4，创建和分发 kubelet systemd unit 文件")]),s._v(" "),t("p",[s._v("创建 kubelet systemd unit 文件模板：")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" kubelet.service.template "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<<")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("EOF\n[Unit]\nDescription=Kubernetes Kubelet\nDocumentation=https://github.com/GoogleCloudPlatform/kubernetes\nAfter=docker.service\nRequires=docker.service\n[Service]\nWorkingDirectory=/var/lib/kubelet\nExecStart=/opt/k8s/bin/kubelet "),t("span",{pre:!0,attrs:{class:"token entity",title:"\\\\"}},[s._v("\\\\")]),s._v("\n  --bootstrap-kubeconfig=/etc/kubernetes/kubelet-bootstrap.kubeconfig "),t("span",{pre:!0,attrs:{class:"token entity",title:"\\\\"}},[s._v("\\\\")]),s._v("\n  --cert-dir=/etc/kubernetes/cert "),t("span",{pre:!0,attrs:{class:"token entity",title:"\\\\"}},[s._v("\\\\")]),s._v("\n  --kubeconfig=/etc/kubernetes/kubelet.kubeconfig "),t("span",{pre:!0,attrs:{class:"token entity",title:"\\\\"}},[s._v("\\\\")]),s._v("\n  --config=/etc/kubernetes/kubelet.config.json "),t("span",{pre:!0,attrs:{class:"token entity",title:"\\\\"}},[s._v("\\\\")]),s._v("\n  --hostname-override=##NODE_NAME## "),t("span",{pre:!0,attrs:{class:"token entity",title:"\\\\"}},[s._v("\\\\")]),s._v("\n  --pod-infra-container-image=registry.access.redhat.com/rhel7/pod-infrastructure:latest "),t("span",{pre:!0,attrs:{class:"token entity",title:"\\\\"}},[s._v("\\\\")]),s._v("\n  --allow-privileged=true "),t("span",{pre:!0,attrs:{class:"token entity",title:"\\\\"}},[s._v("\\\\")]),s._v("\n  --alsologtostderr=true "),t("span",{pre:!0,attrs:{class:"token entity",title:"\\\\"}},[s._v("\\\\")]),s._v("\n  --logtostderr=false "),t("span",{pre:!0,attrs:{class:"token entity",title:"\\\\"}},[s._v("\\\\")]),s._v("\n  --log-dir=/var/log/kubernetes "),t("span",{pre:!0,attrs:{class:"token entity",title:"\\\\"}},[s._v("\\\\")]),s._v("\n  --v=2\nRestart=on-failure\nRestartSec=5\n[Install]\nWantedBy=multi-user.target\nEOF")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br")])]),t("ul",[t("li",[s._v("如果设置了 --hostname-override 选项，则 kube-proxy 也需要设置该选项，否则会出现找不到 Node 的情况；")]),s._v(" "),t("li",[s._v("--bootstrap-kubeconfig：指向 bootstrap kubeconfig 文件，kubelet 使用该文件中的用户名和 token 向 kube-apiserver 发送 TLS Bootstrapping 请求；")]),s._v(" "),t("li",[s._v("K8S approve kubelet 的 csr 请求后，在 --cert-dir 目录创建证书和私钥文件，然后写入 --kubeconfig 文件；")])]),s._v(" "),t("p",[s._v("为各节点创建和分发 kubelet systemd unit 文件：")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" magic.sh "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<<")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"EOF"\n#!/bin/bash\nsource /opt/k8s/bin/environment.sh\nfor node_name in ${NODE_NAMES[@]}\ndo\n    echo ">>> ${node_name}"\n    sed -e "s/##NODE_NAME##/${node_name}/" kubelet.service.template > kubelet-${node_name}.service\n    scp kubelet-${node_name}.service root@${node_name}:/etc/systemd/system/kubelet.service\n    scp kubelet-bootstrap-${node_name}.kubeconfig root@${node_name}:/etc/kubernetes/kubelet-bootstrap.kubeconfig\ndone\nEOF')]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br")])]),t("h2",{attrs:{id:"_5-bootstrap-token-auth-和授予权限"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_5-bootstrap-token-auth-和授予权限"}},[s._v("#")]),s._v(" 5，Bootstrap Token Auth 和授予权限")]),s._v(" "),t("p",[s._v("kublet 启动时查找配置的 –kubeletconfig 文件是否存在，如果不存在则使用 --bootstrap-kubeconfig 向 kube-apiserver 发送证书签名请求 (CSR)。")]),s._v(" "),t("p",[s._v("kube-apiserver 收到 CSR 请求后，对其中的 Token 进行认证（事先使用 kubeadm 创建的 token），认证通过后将请求的 user 设置为 system:bootstrap:，group 设置为 system:bootstrappers，这一过程称为 Bootstrap Token Auth。")]),s._v(" "),t("p",[s._v("默认情况下，这个 user 和 group 没有创建 CSR 的权限，kubelet 启动失败，错误日志如下：")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("$ "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" journalctl "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-u")]),s._v(" kubelet "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-a")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-A")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'certificatesigningrequests'")]),s._v("\nMay 06 06:42:36 kube-node1 kubelet"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("26986")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(": F0506 06:42:36.314378   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("26986")]),s._v(" server.go:233"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" failed to run Kubelet: cannot create certificate signing request: certificatesigningrequests.certificates.k8s.io is forbidden: User "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"system:bootstrap:lemy40"')]),s._v(" cannot create certificatesigningrequests.certificates.k8s.io at the cluster scope\nMay 06 06:42:36 kube-node1 systemd"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(": kubelet.service: Main process exited, "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("code")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("exited, "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("status")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("255")]),s._v("/n/a\nMay 06 06:42:36 kube-node1 systemd"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(": kubelet.service: Failed with result "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'exit-code'")]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(".")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])]),t("p",[s._v("解决办法是：创建一个 clusterrolebinding，将 group system:bootstrappers 和 clusterrole system:node-bootstrapper 绑定：")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("$ kubectl create clusterrolebinding kubelet-bootstrap "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--clusterrole")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("system:node-bootstrapper "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--group")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("system:bootstrappers\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("h2",{attrs:{id:"_6-启动-kubelet-服务"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_6-启动-kubelet-服务"}},[s._v("#")]),s._v(" 6，启动 kubelet 服务")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" magic.sh "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<<")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"EOF"\n#!/bin/bash\nsource /opt/k8s/bin/environment.sh\nfor node_ip in ${NODE_IPS[@]}\ndo\n    echo ">>> ${node_ip}"\n    ssh root@${node_ip} "mkdir -p /var/lib/kubelet"\n    ssh root@${node_ip} "/usr/sbin/swapoff -a"\n    ssh root@${node_ip} "mkdir -p /var/log/kubernetes && chown -R k8s /var/log/kubernetes"\n    ssh root@${node_ip} "systemctl daemon-reload && systemctl enable kubelet && systemctl restart kubelet"\ndone\nEOF')]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br")])]),t("ul",[t("li",[s._v("关闭 swap 分区，否则 kubelet 会启动失败；")]),s._v(" "),t("li",[s._v("必须先创建工作和日志目录；")])]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$journalctl")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-u")]),s._v(" kubelet "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("tail")]),s._v("\nNov "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("24")]),s._v(" 00:41:10 kube-node1 kubelet"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("17331")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(": I1124 00:41:10.255251   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("17331")]),s._v(" container_manager_linux.go:427"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("ContainerManager"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(": Discovered runtime cgroups name: /system.slice/docker.service\nNov "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("24")]),s._v(" 00:46:10 kube-node1 kubelet"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("17331")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(": I1124 00:46:10.255711   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("17331")]),s._v(" container_manager_linux.go:427"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("ContainerManager"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(": Discovered runtime cgroups name: /system.slice/docker.service\nNov "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("24")]),s._v(" 00:51:10 kube-node1 kubelet"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("17331")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(": I1124 00:51:10.256110   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("17331")]),s._v(" container_manager_linux.go:427"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("ContainerManager"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(": Discovered runtime cgroups name: /system.slice/docker.service\nNov "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("24")]),s._v(" 00:56:10 kube-node1 kubelet"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("17331")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(": I1124 00:56:10.256544   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("17331")]),s._v(" container_manager_linux.go:427"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("ContainerManager"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(": Discovered runtime cgroups name: /system.slice/docker.service\nNov "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("24")]),s._v(" 01:01:10 kube-node1 kubelet"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("17331")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(": I1124 01:01:10.259279   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("17331")]),s._v(" container_manager_linux.go:427"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("ContainerManager"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(": Discovered runtime cgroups name: /system.slice/docker.service\nNov "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("24")]),s._v(" 01:06:10 kube-node1 kubelet"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("17331")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(": I1124 01:06:10.259741   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("17331")]),s._v(" container_manager_linux.go:427"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("ContainerManager"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(": Discovered runtime cgroups name: /system.slice/docker.service\nNov "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("24")]),s._v(" 01:11:10 kube-node1 kubelet"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("17331")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(": I1124 01:11:10.260211   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("17331")]),s._v(" container_manager_linux.go:427"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("ContainerManager"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(": Discovered runtime cgroups name: /system.slice/docker.service\nNov "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("24")]),s._v(" 01:16:10 kube-node1 kubelet"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("17331")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(": I1124 01:16:10.261190   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("17331")]),s._v(" container_manager_linux.go:427"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("ContainerManager"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(": Discovered runtime cgroups name: /system.slice/docker.service\nNov "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("24")]),s._v(" 01:21:10 kube-node1 kubelet"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("17331")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(": I1124 01:21:10.261772   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("17331")]),s._v(" container_manager_linux.go:427"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("ContainerManager"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(": Discovered runtime cgroups name: /system.slice/docker.service\nNov "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("24")]),s._v(" 01:26:10 kube-node1 kubelet"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("17331")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(": I1124 01:26:10.262188   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("17331")]),s._v(" container_manager_linux.go:427"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("ContainerManager"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(": Discovered runtime cgroups name: /system.slice/docker.service\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br")])]),t("p",[s._v("kubelet 启动后使用 --bootstrap-kubeconfig 向 kube-apiserver 发送 CSR 请求，当这个 CSR 被 approve 后，kube-controller-manager 为 kubelet 创建 TLS 客户端证书、私钥和 --kubeletconfig 文件。\n注意：kube-controller-manager 需要配置 --cluster-signing-cert-file 和 --cluster-signing-key-file 参数，才会为 TLS Bootstrap 创建证书和私钥。")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("$ kubectl get csr\nNAME                                                   AGE       REQUESTOR                 CONDITION\nnode-csr-QzuuQiuUfcSdp3j5W4B2UOuvQ_n9aTNHAlrLzVFiqrk   43s       system:bootstrap:zkiem5   Pending\nnode-csr-oVbPmU-ikVknpynwu0Ckz_MvkAO_F1j0hmbcDa__sGA   27s       system:bootstrap:mkus5s   Pending\nnode-csr-u0E1-ugxgotO_9FiGXo8DkD6a7-ew8sX2qPE6KPS2IY   13m       system:bootstrap:k0s2bj   Pending\n$ kubectl get nodes\nNo resources found.\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br")])]),t("ul",[t("li",[s._v("三个 work 节点的 csr 均处于 pending 状态；")])]),s._v(" "),t("h3",{attrs:{id:"_1-approve-kubelet-csr-请求"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-approve-kubelet-csr-请求"}},[s._v("#")]),s._v(" 1，approve kubelet CSR 请求")]),s._v(" "),t("p",[s._v("可以手动或自动 approve CSR 请求。推荐使用自动的方式，因为从 v1.8 版本开始，可以自动轮转 approve csr 后生成的证书。")]),s._v(" "),t("h3",{attrs:{id:"_2-手动-approve-csr-请求"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-手动-approve-csr-请求"}},[s._v("#")]),s._v(" 2，手动 approve CSR 请求")]),s._v(" "),t("p",[s._v("查看 CSR 列表：")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("$ kubectl get csr\nNAME                                                   AGE       REQUESTOR                 CONDITION\nnode-csr-QzuuQiuUfcSdp3j5W4B2UOuvQ_n9aTNHAlrLzVFiqrk   43s       system:bootstrap:zkiem5   Pending\nnode-csr-oVbPmU-ikVknpynwu0Ckz_MvkAO_F1j0hmbcDa__sGA   27s       system:bootstrap:mkus5s   Pending\nnode-csr-u0E1-ugxgotO_9FiGXo8DkD6a7-ew8sX2qPE6KPS2IY   13m       system:bootstrap:k0s2bj   Pending\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br")])]),t("p",[s._v("approve CSR：")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("$ kubectl certificate approve node-csr-QzuuQiuUfcSdp3j5W4B2UOuvQ_n9aTNHAlrLzVFiqrk\ncertificatesigningrequest.certificates.k8s.io "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"node-csr-QzuuQiuUfcSdp3j5W4B2UOuvQ_n9aTNHAlrLzVFiqrk"')]),s._v(" approved\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("p",[s._v("查看 Approve 结果：")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("$ kubectl describe  csr node-csr-QzuuQiuUfcSdp3j5W4B2UOuvQ_n9aTNHAlrLzVFiqrk\nName:               node-csr-QzuuQiuUfcSdp3j5W4B2UOuvQ_n9aTNHAlrLzVFiqrk\nLabels:             "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\nAnnotations:        "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\nCreationTimestamp:  Wed, "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("24")]),s._v(" Jun "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2018")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("16")]),s._v(":05:04 +0800\nRequesting User:    system:bootstrap:zkiem5\nStatus:             Approved\nSubject:\n         Common Name:    system:node:kube-node2\n         Serial Number:\n         Organization:   system:nodes\nEvents:  "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br")])]),t("ul",[t("li",[s._v("Requesting User：请求 CSR 的用户，kube-apiserver 对它进行认证和授权；")]),s._v(" "),t("li",[s._v("Subject：请求签名的证书信息；")]),s._v(" "),t("li",[s._v("证书的 CN 是 system:node:kube-node2， Organization 是 system:nodes，kube-apiserver 的 Node 授权模式会授予该证书的相关权限；")])]),s._v(" "),t("h3",{attrs:{id:"_3-自动-approve-csr-请求"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-自动-approve-csr-请求"}},[s._v("#")]),s._v(" 3，自动 approve CSR 请求")]),s._v(" "),t("p",[s._v("创建三个 ClusterRoleBinding，分别用于自动 approve client、renew client、renew server 证书：")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" csr-crb.yaml "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<<")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('EOF\n # Approve all CSRs for the group "system:bootstrappers"\n kind: ClusterRoleBinding\n apiVersion: rbac.authorization.k8s.io/v1\n metadata:\n   name: auto-approve-csrs-for-group\n subjects:\n - kind: Group\n   name: system:bootstrappers\n   apiGroup: rbac.authorization.k8s.io\n roleRef:\n   kind: ClusterRole\n   name: system:certificates.k8s.io:certificatesigningrequests:nodeclient\n   apiGroup: rbac.authorization.k8s.io\n---\n # To let a node of the group "system:nodes" renew its own credentials\n kind: ClusterRoleBinding\n apiVersion: rbac.authorization.k8s.io/v1\n metadata:\n   name: node-client-cert-renewal\n subjects:\n - kind: Group\n   name: system:nodes\n   apiGroup: rbac.authorization.k8s.io\n roleRef:\n   kind: ClusterRole\n   name: system:certificates.k8s.io:certificatesigningrequests:selfnodeclient\n   apiGroup: rbac.authorization.k8s.io\n---\n# A ClusterRole which instructs the CSR approver to approve a node requesting a\n# serving cert matching its client cert.\nkind: ClusterRole\napiVersion: rbac.authorization.k8s.io/v1\nmetadata:\n  name: approve-node-server-renewal-csr\nrules:\n- apiGroups: ["certificates.k8s.io"]\n  resources: ["certificatesigningrequests/selfnodeserver"]\n  verbs: ["create"]\n---\n # To let a node of the group "system:nodes" renew its own server credentials\n kind: ClusterRoleBinding\n apiVersion: rbac.authorization.k8s.io/v1\n metadata:\n   name: node-server-cert-renewal\n subjects:\n - kind: Group\n   name: system:nodes\n   apiGroup: rbac.authorization.k8s.io\n roleRef:\n   kind: ClusterRole\n   name: approve-node-server-renewal-csr\n   apiGroup: rbac.authorization.k8s.io\nEOF')]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br"),t("span",{staticClass:"line-number"},[s._v("30")]),t("br"),t("span",{staticClass:"line-number"},[s._v("31")]),t("br"),t("span",{staticClass:"line-number"},[s._v("32")]),t("br"),t("span",{staticClass:"line-number"},[s._v("33")]),t("br"),t("span",{staticClass:"line-number"},[s._v("34")]),t("br"),t("span",{staticClass:"line-number"},[s._v("35")]),t("br"),t("span",{staticClass:"line-number"},[s._v("36")]),t("br"),t("span",{staticClass:"line-number"},[s._v("37")]),t("br"),t("span",{staticClass:"line-number"},[s._v("38")]),t("br"),t("span",{staticClass:"line-number"},[s._v("39")]),t("br"),t("span",{staticClass:"line-number"},[s._v("40")]),t("br"),t("span",{staticClass:"line-number"},[s._v("41")]),t("br"),t("span",{staticClass:"line-number"},[s._v("42")]),t("br"),t("span",{staticClass:"line-number"},[s._v("43")]),t("br"),t("span",{staticClass:"line-number"},[s._v("44")]),t("br"),t("span",{staticClass:"line-number"},[s._v("45")]),t("br"),t("span",{staticClass:"line-number"},[s._v("46")]),t("br"),t("span",{staticClass:"line-number"},[s._v("47")]),t("br"),t("span",{staticClass:"line-number"},[s._v("48")]),t("br"),t("span",{staticClass:"line-number"},[s._v("49")]),t("br"),t("span",{staticClass:"line-number"},[s._v("50")]),t("br"),t("span",{staticClass:"line-number"},[s._v("51")]),t("br"),t("span",{staticClass:"line-number"},[s._v("52")]),t("br"),t("span",{staticClass:"line-number"},[s._v("53")]),t("br"),t("span",{staticClass:"line-number"},[s._v("54")]),t("br")])]),t("ul",[t("li",[s._v("auto-approve-csrs-for-group：自动 approve node 的第一次 CSR； 注意第一次 CSR 时，请求的 Group 为 system:bootstrappers；")]),s._v(" "),t("li",[s._v("node-client-cert-renewal：自动 approve node 后续过期的 client 证书，自动生成的证书 Group 为 system:nodes;")]),s._v(" "),t("li",[s._v("node-server-cert-renewal：自动 approve node 后续过期的 server 证书，自动生成的证书 Group 为 system:nodes;")])]),s._v(" "),t("p",[s._v("生效配置：")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("$ kubectl apply "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-f")]),s._v(" csr-crb.yaml\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("h2",{attrs:{id:"_7-查看-kublet-的情况"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_7-查看-kublet-的情况"}},[s._v("#")]),s._v(" 7，查看 kublet 的情况")]),s._v(" "),t("p",[s._v("等待一段时间 (1-10 分钟)，三个节点的 CSR 都被自动 approve：")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("$ kubectl get csr\nNAME                                                   AGE       REQUESTOR                 CONDITION\ncsr-98h25                                              6m        system:node:kube-node2    Approved,Issued\ncsr-lb5c9                                              7m        system:node:kube-node3    Approved,Issued\ncsr-m2hn4                                              14m       system:node:kube-node1    Approved,Issued\nnode-csr-7q7i0q4MF_K2TSEJj16At4CJFLlJkHIqei6nMIAaJCU   28m       system:bootstrap:k0s2bj   Approved,Issued\nnode-csr-ND77wk2P8k2lHBtgBaObiyYw0uz1Um7g2pRvveMF-c4   35m       system:bootstrap:mkus5s   Approved,Issued\nnode-csr-Nysmrw55nnM48NKwEJuiuCGmZoxouK4N8jiEHBtLQso   6m        system:bootstrap:zkiem5   Approved,Issued\nnode-csr-QzuuQiuUfcSdp3j5W4B2UOuvQ_n9aTNHAlrLzVFiqrk   1h        system:bootstrap:zkiem5   Approved,Issued\nnode-csr-oVbPmU-ikVknpynwu0Ckz_MvkAO_F1j0hmbcDa__sGA   1h        system:bootstrap:mkus5s   Approved,Issued\nnode-csr-u0E1-ugxgotO_9FiGXo8DkD6a7-ew8sX2qPE6KPS2IY   1h        system:bootstrap:k0s2bj   Approved,Issued\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br")])]),t("p",[s._v("所有节点均 ready：")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$kubectl")]),s._v(" get "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("node")]),s._v("\nNAME         STATUS    ROLES     AGE       VERSION\nkube-node1   Ready     "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("    6h        v1.10.4\nkube-node2   Ready     "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("    6h        v1.10.4\nkube-node3   Ready     "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("    6h        v1.10.4\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br")])]),t("p",[s._v("kube-controller-manager 为各 node 生成了 kubeconfig 文件和公私钥：")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$ls")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-l")]),s._v(" /etc/kubernetes/kubelet.kubeconfig\n-rw------- "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root root "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2296")]),s._v(" Nov "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("23")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("19")]),s._v(":11 /etc/kubernetes/kubelet.kubeconfig\n"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$ls")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-l")]),s._v(" /etc/kubernetes/cert/"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" kubelet\n-rw-r--r-- "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root root "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1046")]),s._v(" Nov "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("23")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("19")]),s._v(":11 kubelet-client.crt\n-rw------- "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root root  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("227")]),s._v(" Nov "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("23")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("19")]),s._v(":09 kubelet-client.key\n-rw------- "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root root "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1334")]),s._v(" Nov "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("23")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("19")]),s._v(":12 kubelet-server-2018-11-23-19-12-50.pem\nlrwxrwxrwx "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root root   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("59")]),s._v(" Nov "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("23")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("19")]),s._v(":12 kubelet-server-current.pem -"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" /etc/kubernetes/cert/kubelet-server-2018-11-23-19-12-50.pem\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br")])]),t("ul",[t("li",[s._v("kubelet-server 证书会周期轮转；")])]),s._v(" "),t("h2",{attrs:{id:"_8-kubelet-提供的-api-接口"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_8-kubelet-提供的-api-接口"}},[s._v("#")]),s._v(" 8，kubelet 提供的 API 接口")]),s._v(" "),t("p",[s._v("kublet 启动后监听多个端口，用于接收 kube-apiserver 或其它组件发送的请求：")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$sudo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("netstat")]),s._v(" -lnpt"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" kubelet\ntcp        "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("      "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".106.3:10250     "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v(".0.0:*               LISTEN      "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("17331")]),s._v("/kubelet\ntcp        "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("      "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".106.3:4194      "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v(".0.0:*               LISTEN      "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("17331")]),s._v("/kubelet\ntcp        "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("      "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1:10248         "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v(".0.0:*               LISTEN      "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("17331")]),s._v("/kubelet\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])]),t("ul",[t("li",[s._v("4194: cadvisor http 服务；")]),s._v(" "),t("li",[s._v("10248: healthz http 服务；")]),s._v(" "),t("li",[s._v("10250: https API 服务；注意：未开启只读端口 10255；")])]),s._v(" "),t("p",[s._v("例如执行 kubectl ec -it nginx-ds-5rmws -- sh 命令时，kube-apiserver 会向 kubelet 发送如下请求：")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("POST /exec/default/nginx-ds-5rmws/my-nginx?command"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("sh"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("input")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("output")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("tty")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("kubelet 接收 10250 端口的 https 请求：")]),s._v(" "),t("ul",[t("li",[s._v("/pods、/runningpods")]),s._v(" "),t("li",[s._v("/metrics、/metrics/cadvisor、/metrics/probes")]),s._v(" "),t("li",[s._v("/spec")]),s._v(" "),t("li",[s._v("/stats、/stats/container")]),s._v(" "),t("li",[s._v("/logs")]),s._v(" "),t("li",[s._v("/run/、”/exec/”, “/attach/”, “/portForward/”, “/containerLogs/” 等管理；")])]),s._v(" "),t("p",[s._v("详情参考：https://github.com/kubernetes/kubernetes/blob/master/pkg/kubelet/server/server.go#L434:3")]),s._v(" "),t("p",[s._v("由于关闭了匿名认证，同时开启了 webhook 授权，所有访问 10250 端口 https API 的请求都需要被认证和授权。")]),s._v(" "),t("p",[s._v("预定义的 ClusterRole system:kubelet-api-admin 授予访问 kubelet 所有 API 的权限：")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$kubectl")]),s._v(" describe clusterrole system:kubelet-api-admin\nName:         system:kubelet-api-admin\nLabels:       kubernetes.io/bootstrapping"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("rbac-defaults\nAnnotations:  rbac.authorization.kubernetes.io/autoupdate"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("true\nPolicyRule:\n  Resources      Non-Resource URLs  Resource Names  Verbs\n  ---------      -----------------  --------------  -----\n  nodes          "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("                 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("              "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("get list "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("watch")]),s._v(" proxy"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n  nodes/log      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("                 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("              "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("*"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n  nodes/metrics  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("                 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("              "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("*"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n  nodes/proxy    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("                 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("              "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("*"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n  nodes/spec     "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("                 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("              "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("*"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n  nodes/stats    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("                 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("              "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("*"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br")])]),t("h2",{attrs:{id:"_9-kublet-api-认证和授权"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_9-kublet-api-认证和授权"}},[s._v("#")]),s._v(" 9，kublet api 认证和授权")]),s._v(" "),t("p",[s._v("kublet 配置了如下认证参数：")]),s._v(" "),t("ul",[t("li",[s._v("authentication.anonymous.enabled：设置为 false，不允许匿名访问 10250 端口；")]),s._v(" "),t("li",[s._v("authentication.x509.clientCAFile：指定签名客户端证书的 CA 证书，开启 HTTPs 证书认证；")]),s._v(" "),t("li",[s._v("authentication.webhook.enabled=true：开启 HTTPs bearer token 认证；")])]),s._v(" "),t("p",[s._v("同时配置了如下授权参数：")]),s._v(" "),t("ul",[t("li",[s._v("authroization.mode=Webhook：开启 RBAC 授权；")])]),s._v(" "),t("p",[s._v("kubelet 收到请求后，使用 clientCAFile 对证书签名进行认证，或者查询 bearer token 是否有效。如果两者都没通过，则拒绝请求，提示 Unauthorized：")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("$ "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-s")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--cacert")]),s._v(" /etc/kubernetes/cert/ca.pem https://192.168.106.5:10250/metrics\nUnauthorized\n$ "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-s")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--cacert")]),s._v(" /etc/kubernetes/cert/ca.pem "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-H")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Authorization: Bearer 123456"')]),s._v(" https://192.168.106.5:10250/metrics\nUnauthorized\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])]),t("p",[s._v("通过认证后，kubelet 使用 SubjectAccessReview API 向 kube-apiserver 发送请求，查询证书或 token 对应的 user、group 是否有操作资源的权限 (RBAC)；")]),s._v(" "),t("p",[s._v("证书认证和授权：")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("$ "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 权限不足的证书；")]),s._v("\n$ "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-s")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--cacert")]),s._v(" /etc/kubernetes/cert/ca.pem "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--cert")]),s._v(" /etc/kubernetes/cert/kube-controller-manager.pem "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--key")]),s._v(" /etc/kubernetes/cert/kube-controller-manager-key.pem https://192.168.106.5:10250/metrics\nForbidden "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("user"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("system:kube-controller-manager, "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("verb")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("get, "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("resource")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("nodes, "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("subresource")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("metrics"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n$ "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 使用部署 kubectl 命令行工具时创建的、具有最高权限的 admin 证书；")]),s._v("\n$ "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-s")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--cacert")]),s._v(" /etc/kubernetes/cert/ca.pem "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--cert")]),s._v(" ./admin.pem "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--key")]),s._v(" ./admin-key.pem https://192.168.106.5:10250/metrics"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("head")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# HELP apiserver_client_certificate_expiration_seconds Distribution of the remaining lifetime on the certificate used to authenticate a request.")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# TYPE apiserver_client_certificate_expiration_seconds histogram")]),s._v("\napiserver_client_certificate_expiration_seconds_bucket"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("le"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"0"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\napiserver_client_certificate_expiration_seconds_bucket"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("le"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"21600"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\napiserver_client_certificate_expiration_seconds_bucket"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("le"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"43200"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\napiserver_client_certificate_expiration_seconds_bucket"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("le"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"86400"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\napiserver_client_certificate_expiration_seconds_bucket"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("le"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"172800"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\napiserver_client_certificate_expiration_seconds_bucket"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("le"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"345600"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\napiserver_client_certificate_expiration_seconds_bucket"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("le"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"604800"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\napiserver_client_certificate_expiration_seconds_bucket"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("le"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"2.592e+06"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br")])]),t("ul",[t("li",[s._v("--cacert、--cert、--key 的参数值必须是文件路径，如上面的 ./admin.pem 不能省略 ./，否则返回 401 Unauthorized；")])]),s._v(" "),t("p",[s._v("bear token 认证和授权：")]),s._v(" "),t("p",[s._v("创建一个 ServiceAccount，将它和 ClusterRole system:kubelet-api-admin 绑定，从而具有调用 kubelet API 的权限：")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("$ kubectl create sa kubelet-api-test\n$ kubectl create clusterrolebinding kubelet-api-test --"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$clusterrole")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("system:kubelet-api-admin "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--serviceaccount")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("default:kubelet-api-test\n$ "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("SECRET")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token variable"}},[t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$(")]),s._v("kubectl get secrets "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" kubelet-api-test "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("awk")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'{print $1}'")]),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v(")")])]),s._v("\n$ "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("TOKEN")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token variable"}},[t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$(")]),s._v("kubectl describe secret $"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("SECRET"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-E")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'^token'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("awk")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'{print $2}'")]),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v(")")])]),s._v("\n$ "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${TOKEN}")]),s._v("\n$ "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-s")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--cacert")]),s._v(" /etc/kubernetes/cert/ca.pem "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-H")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Authorization: Bearer '),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${TOKEN}")]),s._v('"')]),s._v(" https://172.27.129.111:10250/metrics"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("head")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# HELP apiserver_client_certificate_expiration_seconds Distribution of the remaining lifetime on the certificate used to authenticate a request.")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# TYPE apiserver_client_certificate_expiration_seconds histogram")]),s._v("\napiserver_client_certificate_expiration_seconds_bucket"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("le"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"0"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\napiserver_client_certificate_expiration_seconds_bucket"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("le"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"21600"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\napiserver_client_certificate_expiration_seconds_bucket"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("le"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"43200"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\napiserver_client_certificate_expiration_seconds_bucket"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("le"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"86400"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\napiserver_client_certificate_expiration_seconds_bucket"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("le"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"172800"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\napiserver_client_certificate_expiration_seconds_bucket"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("le"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"345600"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\napiserver_client_certificate_expiration_seconds_bucket"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("le"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"604800"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\napiserver_client_certificate_expiration_seconds_bucket"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("le"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"2.592e+06"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br")])]),t("h2",{attrs:{id:"_10-cadvisor-和-metrics"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_10-cadvisor-和-metrics"}},[s._v("#")]),s._v(" 10，cadvisor 和 metrics")]),s._v(" "),t("p",[s._v("cadvisor 统计所在节点各容器的资源 (CPU、内存、磁盘、网卡) 使用情况，分别在自己的 http web 页面 (4194 端口) 和 10250 以 promehteus metrics 的形式输出。")]),s._v(" "),t("p",[s._v("浏览器访问 http://192.168.106.5:4194/containers/ 可以查看到 cadvisor 的监控页面：")]),s._v(" "),t("p",[t("img",{attrs:{src:"http://t.eryajf.net/imgs/2021/09/90642103f50d2a54.jpg",alt:"image"}})]),s._v(" "),t("h2",{attrs:{id:"_11-获取-kublet-的配置"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_11-获取-kublet-的配置"}},[s._v("#")]),s._v(" 11，获取 kublet 的配置")]),s._v(" "),t("p",[s._v("从 kube-apiserver 获取各 node 的配置：")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("$ "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("source")]),s._v(" /opt/k8s/bin/environment.sh\n$ "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 使用部署 kubectl 命令行工具时创建的、具有最高权限的 admin 证书；")]),s._v("\n$ "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-sSL")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--cacert")]),s._v(" /etc/kubernetes/cert/ca.pem "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--cert")]),s._v(" ./admin.pem "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--key")]),s._v(" ./admin-key.pem "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${KUBE_APISERVER}")]),s._v("/api/v1/nodes/kube-node1/proxy/configz "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" jq "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('\'.kubeletconfig|.kind="KubeletConfiguration"|.apiVersion="kubelet.config.k8s.io/v1beta1"\'')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"syncFrequency"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"1m0s"')]),s._v(",\n  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"fileCheckFrequency"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"20s"')]),s._v(",\n  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"httpCheckFrequency"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"20s"')]),s._v(",\n  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"address"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"172.27.129.80"')]),s._v(",\n  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"port"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10250")]),s._v(",\n  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"readOnlyPort"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10255")]),s._v(",\n  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"authentication"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"x509"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(",\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"webhook"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"enabled"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" false,\n      "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"cacheTTL"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"2m0s"')]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(",\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"anonymous"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"enabled"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(",\n  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"authorization"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"mode"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"AlwaysAllow"')]),s._v(",\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"webhook"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"cacheAuthorizedTTL"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"5m0s"')]),s._v(",\n      "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"cacheUnauthorizedTTL"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"30s"')]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(",\n  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"registryPullQPS"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v(",\n  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"registryBurst"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(",\n  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"eventRecordQPS"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v(",\n  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"eventBurst"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(",\n  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"enableDebuggingHandlers"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" true,\n  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"healthzPort"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10248")]),s._v(",\n  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"healthzBindAddress"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"127.0.0.1"')]),s._v(",\n  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"oomScoreAdj"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" -999,\n  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"clusterDomain"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"cluster.local."')]),s._v(",\n  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"clusterDNS"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"10.254.0.2"')]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(",\n  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"streamingConnectionIdleTimeout"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"4h0m0s"')]),s._v(",\n  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"nodeStatusUpdateFrequency"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"10s"')]),s._v(",\n  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"imageMinimumGCAge"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"2m0s"')]),s._v(",\n  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"imageGCHighThresholdPercent"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("85")]),s._v(",\n  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"imageGCLowThresholdPercent"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),s._v(",\n  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"volumeStatsAggPeriod"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"1m0s"')]),s._v(",\n  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"cgroupsPerQOS"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" true,\n  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"cgroupDriver"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"cgroupfs"')]),s._v(",\n  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"cpuManagerPolicy"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"none"')]),s._v(",\n  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"cpuManagerReconcilePeriod"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"10s"')]),s._v(",\n  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"runtimeRequestTimeout"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"2m0s"')]),s._v(",\n  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"hairpinMode"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"promiscuous-bridge"')]),s._v(",\n  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"maxPods"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("110")]),s._v(",\n  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"podPidsLimit"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" -1,\n  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"resolvConf"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/etc/resolv.conf"')]),s._v(",\n  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"cpuCFSQuota"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" true,\n  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"maxOpenFiles"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1000000")]),s._v(",\n  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"contentType"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"application/vnd.kubernetes.protobuf"')]),s._v(",\n  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"kubeAPIQPS"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v(",\n  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"kubeAPIBurst"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(",\n  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"serializeImagePulls"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" false,\n  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"evictionHard"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"imagefs.available"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"15%"')]),s._v(",\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"memory.available"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"100Mi"')]),s._v(",\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"nodefs.available"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"10%"')]),s._v(",\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"nodefs.inodesFree"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"5%"')]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(",\n  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"evictionPressureTransitionPeriod"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"5m0s"')]),s._v(",\n  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"enableControllerAttachDetach"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" true,\n  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"makeIPTablesUtilChains"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" true,\n  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"iptablesMasqueradeBit"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("14")]),s._v(",\n  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"iptablesDropBit"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("15")]),s._v(",\n  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"featureGates"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"RotateKubeletClientCertificate"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" true,\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"RotateKubeletServerCertificate"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(",\n  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"failSwapOn"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" true,\n  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"containerLogMaxSize"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"10Mi"')]),s._v(",\n  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"containerLogMaxFiles"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v(",\n  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"enforceNodeAllocatable"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"pods"')]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(",\n  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"kind"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"KubeletConfiguration"')]),s._v(",\n  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"apiVersion"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"kubelet.config.k8s.io/v1beta1"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br"),t("span",{staticClass:"line-number"},[s._v("30")]),t("br"),t("span",{staticClass:"line-number"},[s._v("31")]),t("br"),t("span",{staticClass:"line-number"},[s._v("32")]),t("br"),t("span",{staticClass:"line-number"},[s._v("33")]),t("br"),t("span",{staticClass:"line-number"},[s._v("34")]),t("br"),t("span",{staticClass:"line-number"},[s._v("35")]),t("br"),t("span",{staticClass:"line-number"},[s._v("36")]),t("br"),t("span",{staticClass:"line-number"},[s._v("37")]),t("br"),t("span",{staticClass:"line-number"},[s._v("38")]),t("br"),t("span",{staticClass:"line-number"},[s._v("39")]),t("br"),t("span",{staticClass:"line-number"},[s._v("40")]),t("br"),t("span",{staticClass:"line-number"},[s._v("41")]),t("br"),t("span",{staticClass:"line-number"},[s._v("42")]),t("br"),t("span",{staticClass:"line-number"},[s._v("43")]),t("br"),t("span",{staticClass:"line-number"},[s._v("44")]),t("br"),t("span",{staticClass:"line-number"},[s._v("45")]),t("br"),t("span",{staticClass:"line-number"},[s._v("46")]),t("br"),t("span",{staticClass:"line-number"},[s._v("47")]),t("br"),t("span",{staticClass:"line-number"},[s._v("48")]),t("br"),t("span",{staticClass:"line-number"},[s._v("49")]),t("br"),t("span",{staticClass:"line-number"},[s._v("50")]),t("br"),t("span",{staticClass:"line-number"},[s._v("51")]),t("br"),t("span",{staticClass:"line-number"},[s._v("52")]),t("br"),t("span",{staticClass:"line-number"},[s._v("53")]),t("br"),t("span",{staticClass:"line-number"},[s._v("54")]),t("br"),t("span",{staticClass:"line-number"},[s._v("55")]),t("br"),t("span",{staticClass:"line-number"},[s._v("56")]),t("br"),t("span",{staticClass:"line-number"},[s._v("57")]),t("br"),t("span",{staticClass:"line-number"},[s._v("58")]),t("br"),t("span",{staticClass:"line-number"},[s._v("59")]),t("br"),t("span",{staticClass:"line-number"},[s._v("60")]),t("br"),t("span",{staticClass:"line-number"},[s._v("61")]),t("br"),t("span",{staticClass:"line-number"},[s._v("62")]),t("br"),t("span",{staticClass:"line-number"},[s._v("63")]),t("br"),t("span",{staticClass:"line-number"},[s._v("64")]),t("br"),t("span",{staticClass:"line-number"},[s._v("65")]),t("br"),t("span",{staticClass:"line-number"},[s._v("66")]),t("br"),t("span",{staticClass:"line-number"},[s._v("67")]),t("br"),t("span",{staticClass:"line-number"},[s._v("68")]),t("br"),t("span",{staticClass:"line-number"},[s._v("69")]),t("br"),t("span",{staticClass:"line-number"},[s._v("70")]),t("br"),t("span",{staticClass:"line-number"},[s._v("71")]),t("br"),t("span",{staticClass:"line-number"},[s._v("72")]),t("br"),t("span",{staticClass:"line-number"},[s._v("73")]),t("br"),t("span",{staticClass:"line-number"},[s._v("74")]),t("br"),t("span",{staticClass:"line-number"},[s._v("75")]),t("br"),t("span",{staticClass:"line-number"},[s._v("76")]),t("br"),t("span",{staticClass:"line-number"},[s._v("77")]),t("br"),t("span",{staticClass:"line-number"},[s._v("78")]),t("br"),t("span",{staticClass:"line-number"},[s._v("79")]),t("br"),t("span",{staticClass:"line-number"},[s._v("80")]),t("br"),t("span",{staticClass:"line-number"},[s._v("81")]),t("br"),t("span",{staticClass:"line-number"},[s._v("82")]),t("br"),t("span",{staticClass:"line-number"},[s._v("83")]),t("br"),t("span",{staticClass:"line-number"},[s._v("84")]),t("br"),t("span",{staticClass:"line-number"},[s._v("85")]),t("br")])]),t("p",[s._v("或者参考代码中的注释：https://github.com/kubernetes/kubernetes/blob/master/pkg/kubelet/apis/kubeletconfig/v1beta1/types.go")]),s._v(" "),t("h2",{attrs:{id:"_12-参考"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_12-参考"}},[s._v("#")]),s._v(" 12，参考")]),s._v(" "),t("p",[s._v("kubelet 认证和授权：https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet-authentication-authorization/")])])}),[],!1,null,null,null);t.default=n.exports}}]);