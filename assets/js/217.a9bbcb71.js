(window.webpackJsonp=window.webpackJsonp||[]).push([[217],{560:function(a,s,t){"use strict";t.r(s);var e=t(0),r=Object(e.a)({},(function(){var a=this,s=a._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":a.$parent.slotKey}},[s("p",[a._v("公司更换了新的服务器, 需要把原先的 gitlab 迁移到新的服务器上。")]),a._v(" "),s("h2",{attrs:{id:"_1-迁移准备工作和思路"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-迁移准备工作和思路"}},[a._v("#")]),a._v(" 1. 迁移准备工作和思路:")]),a._v(" "),s("p",[a._v("从 a 服务器迁移到 b 服务器, 由于 Gitlab 自身的兼容性问题，高版本的 Gitlab 无法恢复低版本备份的数据, 需要注意在 b 服务器部署和 a 服务器一样版本的 gitlab, 部署好环境后开始备份和数据迁移.")]),a._v(" "),s("p",[a._v("查看 gitlab 版本的命令:")]),a._v(" "),s("div",{staticClass:"language-sh line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-sh"}},[s("code",[a._v(" gitlab-rake gitlab:env:info\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br")])]),s("h2",{attrs:{id:"_2-备份原-a-服务器上的的数据"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-备份原-a-服务器上的的数据"}},[a._v("#")]),a._v(" 2. 备份原 a 服务器上的的数据")]),a._v(" "),s("div",{staticClass:"language-sh line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-sh"}},[s("code",[a._v("gitlab-rake gitlab:backup:create "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("RAILS_ENV")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("production\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br")])]),s("p",[s("code",[a._v("PS")]),a._v(": 备份后的文件一般是位于 / var/opt/gitlab/backups 下, 自动生成文件名文件名如 1481529483_gitlab_backup.tar")]),a._v(" "),s("h2",{attrs:{id:"_3-将步骤-2-生成的-tar-文件拷贝到-b-服务器上相应的-backups-目录下"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-将步骤-2-生成的-tar-文件拷贝到-b-服务器上相应的-backups-目录下"}},[a._v("#")]),a._v(" 3. 将步骤 2 生成的 tar 文件拷贝到 b 服务器上相应的 backups 目录下")]),a._v(" "),s("p",[a._v("可以利用 scp 进行直接拷贝.")]),a._v(" "),s("div",{staticClass:"language-sh line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-sh"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[a._v("scp")]),a._v(" username@src_ip:/var/opt/gitlab/backups/1481529483_gitlab_backup.tar /var/opt/gitlab/backups\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br")])]),s("p",[s("code",[a._v("PS")]),a._v(": username 为原服务器的用户名，src_ip 原服务器 IP 地址")]),a._v(" "),s("h2",{attrs:{id:"_4-在-b-服务器恢复数据"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_4-在-b-服务器恢复数据"}},[a._v("#")]),a._v(" 4. 在 b 服务器恢复数据")]),a._v(" "),s("div",{staticClass:"language-sh line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-sh"}},[s("code",[a._v("gitlab-rake gitlab:backup:restore "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("RAILS_ENV")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("production "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("BACKUP")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("/var/opt/gitlab/backups/1511876879_2017_11_28_10.1.0\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br")])]),s("p",[s("img",{attrs:{src:"http://t.eryajf.net/imgs/2021/09/6a6550e2aa820412.jpg",alt:"image"}})]),a._v(" "),s("p",[s("code",[a._v("PS")]),a._v("：BACKUP 的时间点必须与原服务器备份后的文件名一致")]),a._v(" "),s("p",[s("code",[a._v("PPS")]),a._v("：一般备份出来的名字是这样的，命令使用格式是 git 前边的数据就行")]),a._v(" "),s("p",[s("img",{attrs:{src:"http://t.eryajf.net/imgs/2021/09/1f40764cc2ed240a.jpg",alt:"image"}})]),a._v(" "),s("p",[a._v("OK，恢复成功！")]),a._v(" "),s("h2",{attrs:{id:"_5-通过脚本定时备份"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_5-通过脚本定时备份"}},[a._v("#")]),a._v(" 5. 通过脚本定时备份")]),a._v(" "),s("p",[a._v("写一个简单的脚本，加入到定时任务，以保证每天备份一次代码到异地。")]),a._v(" "),s("p",[a._v("写脚本之前，先创建一下对应的工作目录：")]),a._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v("$ mkdir /backup\n$ touch /backup/logfile.txt\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br")])]),s("p",[a._v("脚本内容如下：")]),a._v(" "),s("div",{staticClass:"language-sh line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-sh"}},[s("code",[s("span",{pre:!0,attrs:{class:"token shebang important"}},[a._v("#!/bin/bash")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("Bakupdir")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("/var/opt/gitlab/backups/\n"),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("Logfile")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("/backup/logfile.txt\n"),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("Date")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token variable"}},[s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("`")]),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("date")]),a._v(" +%Y-%m-%d"),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("`")])]),a._v("\ngitlab-rake gitlab:backup:create "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("RAILS_ENV")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("production\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("if")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$?")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-eq")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("0")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("then")]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("echo")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"'),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$Date")]),a._v(' Backup Successful"')]),a._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">>")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$Logfile")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("else")]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("echo")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"'),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$Date")]),a._v(' Backup Failed"')]),a._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">>")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$Logfile")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("fi")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("cd")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$Bakupdir")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("scp")]),a._v(" *.tar backup@192.168.106.222:/home/backup/gitbak\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("rm")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-rf")]),a._v(" *\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br"),s("span",{staticClass:"line-number"},[a._v("3")]),s("br"),s("span",{staticClass:"line-number"},[a._v("4")]),s("br"),s("span",{staticClass:"line-number"},[a._v("5")]),s("br"),s("span",{staticClass:"line-number"},[a._v("6")]),s("br"),s("span",{staticClass:"line-number"},[a._v("7")]),s("br"),s("span",{staticClass:"line-number"},[a._v("8")]),s("br"),s("span",{staticClass:"line-number"},[a._v("9")]),s("br"),s("span",{staticClass:"line-number"},[a._v("10")]),s("br"),s("span",{staticClass:"line-number"},[a._v("11")]),s("br"),s("span",{staticClass:"line-number"},[a._v("12")]),s("br"),s("span",{staticClass:"line-number"},[a._v("13")]),s("br")])]),s("p",[a._v("然后将脚本加入定时任务，根据需求，定期执行即可！")]),a._v(" "),s("h2",{attrs:{id:"_6-出错解决"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_6-出错解决"}},[a._v("#")]),a._v(" 6. 出错解决")]),a._v(" "),s("p",[a._v("数据迁移到后检查登录 gialab 有时候会跳出 500 报错 (Something went wrong on our end.) 以及无法正常新建用户")]),a._v(" "),s("div",{staticClass:"language-sh line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-sh"}},[s("code",[a._v("查看日志: "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("tail")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-f")]),a._v(" /var/log/gitlab/redis/current\nCan’t save "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("in")]),a._v(" background: fork: Cannot allocate memory\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br")])]),s("p",[a._v("解决方案")]),a._v(" "),s("p",[a._v("修改 "),s("code",[a._v("/ etc/sysctl.conf")])]),a._v(" "),s("p",[a._v("加上 "),s("code",[a._v("vm.overcommit_memory = 1")]),a._v(", Linux 内核会根据参数 vm.overcommit_memory 参数的设置决定是否放行。")]),a._v(" "),s("p",[a._v("修改完执行 "),s("code",[a._v("sysctl -p")])]),a._v(" "),s("div",{staticClass:"language-sh line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-sh"}},[s("code",[a._v("vm.overcommit_memory "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("1")]),a._v("，直接放行\nvm.overcommit_memory "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("0")]),a._v("：则比较 此次请求分配的虚拟内存大小和系统当前空闲的物理内存加上 swap，决定是否放行。\nvm.overcommit_memory "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("2")]),a._v("：则会比较进程所有已分配的虚拟内存加上此次请求分配的虚拟内\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br"),s("span",{staticClass:"line-number"},[a._v("3")]),s("br")])]),s("p",[a._v("参考网址：http://wenva.github.io/git/2016/04/22/Gitlab%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%BF%81%E7%A7%BB.html")])])}),[],!1,null,null,null);s.default=r.exports}}]);