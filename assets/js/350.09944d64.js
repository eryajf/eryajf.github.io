(window.webpackJsonp=window.webpackJsonp||[]).push([[350],{693:function(s,a,t){"use strict";t.r(a);var e=t(0),n=Object(e.a)({},(function(){var s=this,a=s._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h2",{attrs:{id:"_1-前言。"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-前言。"}},[s._v("#")]),s._v(" 1，前言。")]),s._v(" "),a("p",[s._v("有时候我们在测试环境当中，可能同一个项目，需要部署多套的环境，这个时候可以针对每套环境来创建多个项目进行构建，这样做不无不可，但是今天要介绍一个插件，可以非常优雅的将这些情况，浓缩到一个 job 里边。")]),s._v(" "),a("p",[s._v("刚刚还在一个博主的自我介绍里看到这样一句话："),a("code",[s._v("喜欢一切优雅的运维方式···")])]),s._v(" "),a("p",[s._v("通过今天的这个插件，可以让我们优雅很多。")]),s._v(" "),a("h2",{attrs:{id:"_2-插件介绍。"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-插件介绍。"}},[s._v("#")]),s._v(" 2，插件介绍。")]),s._v(" "),a("ul",[a("li",[s._v("官方地址：https://wiki.jenkins.io/display/JENKINS/Active+Choices+Plugin")]),s._v(" "),a("li",[s._v("安装方式：在 Jenkins 插件当中直接搜索即可安装。")]),s._v(" "),a("li",[s._v("功能说明：根据所选参数，自动调出对应参数所依赖的后续参数。")])]),s._v(" "),a("h2",{attrs:{id:"_3-使用插件前的方案。"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-使用插件前的方案。"}},[s._v("#")]),s._v(" 3，使用插件前的方案。")]),s._v(" "),a("p",[a("img",{attrs:{src:"http://t.eryajf.net/imgs/2021/09/655045461c8c1afb.jpg",alt:"image"}})]),s._v(" "),a("p",[s._v("那么在这种需求之下，基本思路就是，创建两个项目，每个项目负责进行分发部署。详细配置不讲解了，直接看截图内容：")]),s._v(" "),a("p",[a("img",{attrs:{src:"http://t.eryajf.net/imgs/2021/09/edca18e0386e4ce9.jpg",alt:"image"}})]),s._v(" "),a("p",[s._v("简单说就是创建一个自由风格的项目，可以部署到 192.168.10.1 以及 192.168.10.2 上去，然后再创建一个项目 b，内容也是一样，只不过分发主机变成了 192.168.10.3 和 192.168.10.4。这么做其实也没什么，但是有点不太优雅。")]),s._v(" "),a("h2",{attrs:{id:"_4-使用插件后的方案。"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-使用插件后的方案。"}},[s._v("#")]),s._v(" 4，使用插件后的方案。")]),s._v(" "),a("p",[s._v("首先安装上边介绍的插件，接着对项目开始进行配置。")]),s._v(" "),a("p",[s._v("这里着重介绍一下参数以及使用新参数构建时的部署脚本的调整。")]),s._v(" "),a("h3",{attrs:{id:"_1-添加-active-choices-parameter。"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-添加-active-choices-parameter。"}},[s._v("#")]),s._v(" 1，添加 Active Choices Parameter。")]),s._v(" "),a("p",[s._v("去掉刚刚的 host 的选项参数，然后替换为 Active Choices Parameter，首选设置第一道参数，也就是我们刚刚规划的两套环境的参数：")]),s._v(" "),a("p",[a("img",{attrs:{src:"http://t.eryajf.net/imgs/2021/09/dc8803636120e04e.jpg",alt:"image"}})]),s._v(" "),a("ul",[a("li",[a("p",[s._v("name:定义一个名称为 plan 的参数，是的，已经开始了，我们的 A 计划以及 B 计划。")])]),s._v(" "),a("li",[a("p",[s._v("script:这里使用 Jenkins 的 groovy 语言进行编写，不了解也没关系，按这个来修改即可。")])]),s._v(" "),a("li",[a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v("return"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Aplan"')]),s._v(",\n"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Bplan"')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])])]),s._v(" "),a("li",[a("p",[s._v("Description：写入一些描述信息。")])]),s._v(" "),a("li",[a("p",[s._v("Choice Type：这里定义的是构建时选择的类型，这个地方推荐使用 Radio Buttons。")])])]),s._v(" "),a("p",[s._v("接着来添加上述定义参数所依赖的第二步骤参数。")]),s._v(" "),a("h3",{attrs:{id:"_2-添加-active-choices-reactive-parameter。"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-添加-active-choices-reactive-parameter。"}},[s._v("#")]),s._v(" 2，添加 Active Choices Reactive Parameter。")]),s._v(" "),a("p",[s._v("通过添加被动参数，从而实现如上参数选择之后，此处配置的参数自动跟随变动的效果：")]),s._v(" "),a("p",[a("img",{attrs:{src:"http://t.eryajf.net/imgs/2021/09/d3469f97a65e117f.jpg",alt:"image"}})]),s._v(" "),a("ul",[a("li",[a("p",[s._v("Name：定义一个名称为 host 的参数，从而追随如上我们定义的 A 计划或者 B 计划。")])]),s._v(" "),a("li",[a("p",[s._v("script：特有的格式，如果需要更多参数，动态添加即可。")])]),s._v(" "),a("li",[a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("A")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"all"')]),s._v(","),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"192.168.10.1"')]),s._v(","),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"192.168.10.2"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("B")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"all"')]),s._v(","),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"192.168.10.3"')]),s._v(","),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"192.168.10.4"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\nif"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("plan.equals"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Aplan"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("))")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("return")]),s._v(" A\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\nif"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("plan.equals"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Bplan"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("))")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("return")]),s._v(" B\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br")])])]),s._v(" "),a("li",[a("p",[s._v("Description：写入一些描述信息。")])]),s._v(" "),a("li",[a("p",[s._v("Choice Type：这里定义的是构建时选择的类型，这个地方推荐使用默认的。")])])]),s._v(" "),a("h3",{attrs:{id:"_3-调整-shell。"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-调整-shell。"}},[s._v("#")]),s._v(" 3，调整 shell。")]),s._v(" "),a("p",[s._v("接下来要做的工作，就是根据如上定义的参数，进行相应的调整，从而适用于新的构建方式，我这里简单做了一个小例子作为展示：")]),s._v(" "),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("##set color##")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function-name function"}},[s._v("echoRed")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("$'"),a("span",{pre:!0,attrs:{class:"token entity",title:"\\e"}},[s._v("\\e")]),s._v("[0;31m'")]),s._v('"'),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$1")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("\"$'"),a("span",{pre:!0,attrs:{class:"token entity",title:"\\e"}},[s._v("\\e")]),s._v("[0m'; }\nechoGreen() { echo $'"),a("span",{pre:!0,attrs:{class:"token entity",title:"\\e"}},[s._v("\\e")]),s._v("[0;32m'\"")]),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$1")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("\"$'"),a("span",{pre:!0,attrs:{class:"token entity",title:"\\e"}},[s._v("\\e")]),s._v("[0m'; }\nechoYellow() { echo $'"),a("span",{pre:!0,attrs:{class:"token entity",title:"\\e"}},[s._v("\\e")]),s._v("[0;33m'\"")]),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$1")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("\"$'"),a("span",{pre:!0,attrs:{class:"token entity",title:"\\e"}},[s._v("\\e")]),s._v("[0m'; }\n##set color##\n\nsource /etc/profile\nproject=\"")]),s._v("config"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"\nremote_user="')]),s._v("root"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"\nremote_port="')]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("22")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"\nremote_dir=/usr/local/'),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$project")]),s._v("\nscript_dir=/usr/local/scripts\n\n#cd "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$WORKSPACE")]),s._v(" && mvn  clean install -DskipTests=true\n\ndeploy(){\n    IP="),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$1")]),s._v('\n    echoGreen "')]),s._v("start "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("scp")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$project")]),s._v("  on "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$IP")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"\n    #scp -P '),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$remote_port")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$project")]),s._v(".jar "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$remote_user")]),s._v("@"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$IP")]),s._v(":"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$remote_dir")]),s._v("/"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$project")]),s._v('.jar && echo "')]),s._v("success "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("scp")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$project")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"\n    #ssh -p '),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$remote_port")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$remote_user")]),s._v("@"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$IP")]),s._v(' "')]),s._v("/bin/bash "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$script_dir")]),s._v("/deploy.sh "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$mode")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$project")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"\n}\n\nif [ '),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$mode")]),s._v(' == "')]),s._v("deploy"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('" ];then\n  if [ '),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$plan")]),s._v(' == "')]),s._v("Aplan"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('" ];then\n  echoRed "')]),s._v("您选择执行的是A计划"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"\n    if [ '),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$host")]),s._v(' == "')]),s._v("all"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('" ];then\n      deploy 192.168.10.1\n      sleep 3\n      deploy 192.168.10.2\n    else\n      deploy '),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$host")]),s._v("\n    fi\n  elif [ "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$plan")]),s._v(' == "')]),s._v("Bplan"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('" ];then\n  echoRed "')]),s._v("您选择执行的是B计划"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"\n    if [ '),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$host")]),s._v(' == "')]),s._v('all" '),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v("\n      deploy "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".10.3\n      "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sleep")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("\n      deploy "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".10.4\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("else")]),s._v("\n      deploy "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$host")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("fi")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("fi")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("fi")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br"),a("span",{staticClass:"line-number"},[s._v("42")]),a("br"),a("span",{staticClass:"line-number"},[s._v("43")]),a("br")])]),a("p",[s._v("最后来张完整截图：")]),s._v(" "),a("p",[a("img",{attrs:{src:"http://t.eryajf.net/imgs/2021/09/a6e19981d440fa9c.jpg",alt:"image"}})]),s._v(" "),a("p",[s._v("5，验证效果。")]),s._v(" "),a("p",[s._v("先来看最神奇的一个小展示：")]),s._v(" "),a("p",[a("img",{attrs:{src:"http://t.eryajf.net/imgs/2021/09/85f013cc8efe13fa.gif",alt:"2018120512133385"}})]),s._v(" "),a("p",[s._v("可以看到，效果已经如我们所需求的那样，同一套代码下，首先分出 A 计划与 B 计划，然后再每套计划之下，又能有不同的需求走向可供选择，堪称完美。")]),s._v(" "),a("p",[s._v("接下来真正的构建一下，真刀真枪的拉出来练一练。这里我只是为了演示，并没有连接代码库，不过每个地方的构建走向都有清晰的打印输出，所以也能够很容易看出效果。")]),s._v(" "),a("ul",[a("li",[s._v("首先来构建一下 A 计划的 all 主机，看看效果。")])]),s._v(" "),a("p",[a("img",{attrs:{src:"http://t.eryajf.net/imgs/2021/09/f6c923d22d8a1586.jpg",alt:"image"}})]),s._v(" "),a("p",[s._v("通过构建日志可以看到，构建已经触及到 A 计划所囊括的两台主机了。")]),s._v(" "),a("ul",[a("li",[s._v("再来构建一下 B 计划的 all 主机，看看效果。")])]),s._v(" "),a("p",[a("img",{attrs:{src:"http://t.eryajf.net/imgs/2021/09/5e63fc95cdc98bfc.jpg",alt:"image"}})]),s._v(" "),a("p",[s._v("同样的效果，构建就走向了 B 计划囊括的两台主机了。")]),s._v(" "),a("p",[s._v("最后构建一下 B 计划的第一台主机，看看效果。")]),s._v(" "),a("p",[a("img",{attrs:{src:"http://t.eryajf.net/imgs/2021/09/4e0a215c91ed295a.jpg",alt:"image"}})]),s._v(" "),a("p",[s._v("可见，各个流向都是通了的，这样，就把我们一开始的需求，使用一种优雅的方式，给实现了出来。")])])}),[],!1,null,null,null);a.default=n.exports}}]);