(window.webpackJsonp=window.webpackJsonp||[]).push([[439],{782:function(s,a,e){"use strict";e.r(a);var t=e(0),n=Object(t.a)({},(function(){var s=this,a=s._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("p",[s._v("使用 k8s 时，执行如下命令删除一个 namespace：")]),s._v(" "),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v("$ kubectl delete ns "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("local")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("随后查看该 ns 的状态，可以看到该 ns 始终保持在 Terminating 状态：")]),s._v(" "),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v("$ kubectl get ns "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("local")]),s._v("\n\nNAME    STATUS        AGE\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("local")]),s._v("   Terminating   3d1h\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("p",[s._v("如果出现这种问题，一般情况下都是"),a("code",[s._v("finalizers")]),s._v("字段捣的鬼。")]),s._v(" "),a("p",[s._v("参看这篇文章："),a("a",{attrs:{href:"https://developer.aliyun.com/article/772044",target:"_blank",rel:"noopener noreferrer"}},[s._v("熟悉又陌生的 k8s 字段：finalizers"),a("OutboundLink")],1),s._v(" 可以了解到：")]),s._v(" "),a("blockquote",[a("p",[s._v("Finalizers 字段属于 Kubernetes GC 垃圾收集器，是一种删除拦截机制，能够让控制器实现异步的删除前（Pre-delete）回调。其存在于任何一个资源对象的  "),a("a",{attrs:{href:"https://github.com/kubernetes/apimachinery/blob/master/pkg/apis/meta/v1/types.go#L246",target:"_blank",rel:"noopener noreferrer"}},[s._v("Meta"),a("OutboundLink")],1),s._v("  中，在 k8s 源码中声明为  "),a("code",[s._v("[]string")]),s._v("，该 Slice 的内容为需要执行的拦截器名称。")])]),s._v(" "),a("p",[s._v("通常删除不掉可能是因为集群内有某些 webhook，从而导致这个问题，如果此时该 webhook 并不能确定是否可以删除，那么网上提到的，直接编辑 ns，删除 finalizers 的值是无法解决的，仍旧会遇到如下报错：")]),s._v(" "),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v("$ kubectl edit ns "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("local")]),s._v("\n\nerror: namespaces "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"local"')]),s._v(" could not be patched: Internal error occurred: failed calling webhook "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"rancherauth.cattle.io"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" Post "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"https://rancher-webhook.cattle-system.svc:443/v1/webhook/validation?timeout=10s"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" no endpoints available "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("service")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"rancher-webhook"')]),s._v("\nYou can run "),a("span",{pre:!0,attrs:{class:"token variable"}},[a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")]),s._v("kubectl replace "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-f")]),s._v(" /tmp/kubectl-edit-550962354.yaml"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")])]),s._v(" to try this update again.\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("p",[s._v("这个时候，可以参考此文档的方案解决："),a("a",{attrs:{href:"https://medium.com/%E8%BC%95%E9%AC%86%E5%B0%8F%E5%93%81-pks%E8%88%87k8s%E7%9A%84%E9%BB%9E%E6%BB%B4/%E7%A7%BB%E9%99%A4%E8%A9%B2%E6%AD%BB%E7%9A%84terminating-namespace-c6594ebe351",target:"_blank",rel:"noopener noreferrer"}},[s._v("移除該死的 Terminating Namespace"),a("OutboundLink")],1)]),s._v(" "),a("p",[s._v("上边文档最后留了一个脚本，用于删除这种状态的 namespace 的 finalizers 字段，因为脚本还缺了一些内容，因此调整之后补充如下：")]),s._v(" "),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token shebang important"}},[s._v("#!/bin/bash")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$#")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-ne")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Please input only namespace name"')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exit")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("fi")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ns")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$1")]),s._v("\nkubectl get ns "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${ns}")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-o")]),s._v(" json "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" tmp.json\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" ./tmp.json "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" jq "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'del(.spec.finalizers[])'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" ./modify.json\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" ./tmp.json "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" jq "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'del(.metadata.finalizers[])'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" ./modify.json\nkubectl replace "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--raw")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/api/v1/namespaces/'),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${ns}")]),s._v('/finalize"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-f")]),s._v(" ./modify.json\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("rm")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-f")]),s._v(" tmp.json modify.json\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br")])]),a("p",[s._v("然后执行脚本，将名称空间放在第一个位置参数即可："),a("code",[s._v("bash remove-ns.sh local")]),s._v("。")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://t.eryajf.net/imgs/2023/07/1689427249424.jpg",alt:"1689427249424"}})])])}),[],!1,null,null,null);a.default=n.exports}}]);